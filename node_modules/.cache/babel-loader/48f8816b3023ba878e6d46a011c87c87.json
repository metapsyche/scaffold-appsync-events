{"ast":null,"code":"\"use strict\";\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n/*!\n * Copyright 2017-2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n * SPDX-License-Identifier: Apache-2.0\n */\n\nvar apollo_link_1 = require(\"apollo-link\");\n\nvar apollo_link_retry_1 = require(\"apollo-link-retry\");\n\nvar utils_1 = require(\"../utils\");\n\nvar ConflictResolutionLink =\n/** @class */\nfunction (_super) {\n  __extends(ConflictResolutionLink, _super);\n\n  function ConflictResolutionLink(conflictResolver, maxRetries) {\n    if (maxRetries === void 0) {\n      maxRetries = 10;\n    }\n\n    var _this = _super.call(this) || this;\n\n    _this.conflictResolver = conflictResolver;\n    _this.maxRetries = maxRetries;\n    _this.link = apollo_link_1.ApolloLink.from([new apollo_link_retry_1.RetryLink({\n      delay: {\n        initial: 0,\n        max: 0\n      },\n      attempts: function (count, operation, error) {\n        if (count > _this.maxRetries) {\n          return false;\n        }\n\n        if (_this.hasConflictError(error)) {\n          if (typeof _this.conflictResolver === 'function') {\n            var data = error.data;\n            var mutation = operation.query;\n            var mutationName = utils_1.getOperationFieldName(mutation);\n            var operationType = 'mutation';\n            var retries = count;\n\n            var variables = __assign({}, operation.variables);\n\n            var newVars = _this.conflictResolver({\n              data: data,\n              mutation: mutation,\n              mutationName: mutationName,\n              operationType: operationType,\n              retries: retries,\n              variables: variables\n            });\n\n            if (newVars === 'DISCARD') {\n              return false;\n            }\n\n            if (newVars) {\n              operation.variables = newVars;\n              return true;\n            }\n          }\n        }\n\n        return false;\n      }\n    }), new apollo_link_1.ApolloLink(function (op, fwd) {\n      return new apollo_link_1.Observable(function (observer) {\n        fwd(op).subscribe({\n          next: function (data) {\n            var err = (data.errors || []).find(_this.hasConflictError);\n\n            if (err) {\n              observer.error(err);\n            } else {\n              observer.next(__assign(__assign({}, data), {\n                context: __assign(__assign({}, data.context), {\n                  additionalDataContext: {\n                    newVars: op.variables\n                  }\n                })\n              }));\n            }\n          },\n          error: observer.error.bind(observer),\n          complete: observer.complete.bind(observer)\n        });\n        return function () {\n          return null;\n        };\n      });\n    })]);\n    return _this;\n  }\n\n  ConflictResolutionLink.prototype.hasConflictError = function (error) {\n    var hasConflictError = ['DynamoDB:ConditionalCheckFailedException'].some(function (err) {\n      return err === error.errorType;\n    });\n    return hasConflictError;\n  };\n\n  ConflictResolutionLink.prototype.request = function (operation, forward) {\n    if (typeof this.conflictResolver !== 'function') {\n      return utils_1.passthroughLink(operation, forward);\n    }\n\n    return this.link.request(operation, forward);\n  };\n\n  return ConflictResolutionLink;\n}(apollo_link_1.ApolloLink);\n\nexports.default = ConflictResolutionLink;","map":{"version":3,"names":["__extends","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__","constructor","prototype","create","__assign","assign","t","s","i","n","arguments","length","call","apply","defineProperty","exports","value","apollo_link_1","require","apollo_link_retry_1","utils_1","ConflictResolutionLink","_super","conflictResolver","maxRetries","_this","link","ApolloLink","from","RetryLink","delay","initial","max","attempts","count","operation","error","hasConflictError","data","mutation","query","mutationName","getOperationFieldName","operationType","retries","variables","newVars","op","fwd","Observable","observer","subscribe","next","err","errors","find","context","additionalDataContext","bind","complete","some","errorType","request","forward","passthroughLink","default"],"sources":["/Users/roaldmaravillas/ro/github/scaffold-appsync-events/node_modules/aws-appsync/lib/link/conflict-resolution-link.js"],"sourcesContent":["\"use strict\";\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar __assign = (this && this.__assign) || function () {\n    __assign = Object.assign || function(t) {\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\n            s = arguments[i];\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n                t[p] = s[p];\n        }\n        return t;\n    };\n    return __assign.apply(this, arguments);\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\n/*!\n * Copyright 2017-2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n * SPDX-License-Identifier: Apache-2.0\n */\nvar apollo_link_1 = require(\"apollo-link\");\nvar apollo_link_retry_1 = require(\"apollo-link-retry\");\nvar utils_1 = require(\"../utils\");\nvar ConflictResolutionLink = /** @class */ (function (_super) {\n    __extends(ConflictResolutionLink, _super);\n    function ConflictResolutionLink(conflictResolver, maxRetries) {\n        if (maxRetries === void 0) { maxRetries = 10; }\n        var _this = _super.call(this) || this;\n        _this.conflictResolver = conflictResolver;\n        _this.maxRetries = maxRetries;\n        _this.link = apollo_link_1.ApolloLink.from([\n            new apollo_link_retry_1.RetryLink({\n                delay: { initial: 0, max: 0 },\n                attempts: function (count, operation, error) {\n                    if (count > _this.maxRetries) {\n                        return false;\n                    }\n                    if (_this.hasConflictError(error)) {\n                        if (typeof _this.conflictResolver === 'function') {\n                            var data = error.data;\n                            var mutation = operation.query;\n                            var mutationName = utils_1.getOperationFieldName(mutation);\n                            var operationType = 'mutation';\n                            var retries = count;\n                            var variables = __assign({}, operation.variables);\n                            var newVars = _this.conflictResolver({\n                                data: data,\n                                mutation: mutation,\n                                mutationName: mutationName,\n                                operationType: operationType,\n                                retries: retries,\n                                variables: variables,\n                            });\n                            if (newVars === 'DISCARD') {\n                                return false;\n                            }\n                            if (newVars) {\n                                operation.variables = newVars;\n                                return true;\n                            }\n                        }\n                    }\n                    return false;\n                }\n            }),\n            new apollo_link_1.ApolloLink(function (op, fwd) { return new apollo_link_1.Observable(function (observer) {\n                fwd(op).subscribe({\n                    next: function (data) {\n                        var err = (data.errors || []).find(_this.hasConflictError);\n                        if (err) {\n                            observer.error(err);\n                        }\n                        else {\n                            observer.next(__assign(__assign({}, data), { context: __assign(__assign({}, data.context), { additionalDataContext: {\n                                        newVars: op.variables,\n                                    } }) }));\n                        }\n                    },\n                    error: observer.error.bind(observer),\n                    complete: observer.complete.bind(observer),\n                });\n                return function () { return null; };\n            }); })\n        ]);\n        return _this;\n    }\n    ConflictResolutionLink.prototype.hasConflictError = function (error) {\n        var hasConflictError = [\n            'DynamoDB:ConditionalCheckFailedException'\n        ].some(function (err) { return err === error.errorType; });\n        return hasConflictError;\n    };\n    ConflictResolutionLink.prototype.request = function (operation, forward) {\n        if (typeof this.conflictResolver !== 'function') {\n            return utils_1.passthroughLink(operation, forward);\n        }\n        return this.link.request(operation, forward);\n    };\n    return ConflictResolutionLink;\n}(apollo_link_1.ApolloLink));\nexports.default = ConflictResolutionLink;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}