{"ast":null,"code":"\"use strict\";\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\n\nvar __spreadArrays = this && this.__spreadArrays || function () {\n  for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\n\n  for (var r = Array(s), k = 0, i = 0; i < il; i++) for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++) r[k] = a[j];\n\n  return r;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar apollo_cache_inmemory_1 = require(\"apollo-cache-inmemory\");\n\nvar offline_cache_1 = require(\"./cache/offline-cache\");\n\nvar apollo_utilities_1 = require(\"apollo-utilities\");\n\nvar utils_1 = require(\"./utils\");\n\nvar apollo_link_1 = require(\"apollo-link\");\n\nvar retry_link_1 = require(\"./link/retry-link\");\n\nvar graphql_1 = require(\"graphql\");\n\nvar offline_1 = require(\"./helpers/offline\");\n\nvar offline_link_1 = require(\"./link/offline-link\");\n\nvar aws_appsync_subscription_link_1 = require(\"aws-appsync-subscription-link\");\n\nvar logger = utils_1.rootLogger.extend('deltasync');\nexports.DELTASYNC_KEY = 'deltaSync'; //#endregion\n//#region Constants\n\nvar actions = {\n  ENQUEUE: 'DELTASYNC_ENQUEUE_RECONNECT',\n  UPDATE_LASTSYNC: 'DELTASYNC_UPDATE_LASTSYNC'\n};\nvar DEFAULT_UPPER_BOUND_TIME_MS = 24 * 60 * 60 * 1000;\nvar MIN_UPPER_BOUND_TIME_MS = 2 * 1000;\nvar BUFFER_MILLISECONDS = 2000; //#endregion\n//#region helpers\n\nvar subscriptionMessagesProcessorCreator = function (proxy, updateFunction) {\n  var buffer = [];\n  var ready = false;\n\n  var wrappedUpdateFunction = function (proxy, record) {\n    return apollo_utilities_1.tryFunctionOrLogError(function () {\n      return updateFunction(proxy, record);\n    });\n  };\n\n  var processor = {\n    enqueue: function (record) {\n      if (ready) {\n        wrappedUpdateFunction(proxy, record);\n        return;\n      }\n\n      buffer.push(record);\n    },\n    ready: function () {\n      if (ready) {\n        return;\n      }\n\n      buffer.forEach(function (record) {\n        return wrappedUpdateFunction(proxy, record);\n      });\n      buffer = [];\n      ready = true;\n    },\n    close: function () {\n      buffer = [];\n      ready = true;\n    }\n  };\n  return processor;\n};\n\nexports.hashForOptions = function (options) {\n  var _a = options.baseQuery,\n      _b = _a === void 0 ? {} : _a,\n      _c = _b.query,\n      baseQueryQuery = _c === void 0 ? null : _c,\n      _d = _b.variables,\n      baseQueryVariables = _d === void 0 ? {} : _d,\n      _e = options.subscriptionQuery,\n      _f = _e === void 0 ? {} : _e,\n      _g = _f.query,\n      subscriptionQueryQuery = _g === void 0 ? null : _g,\n      _h = _f.variables,\n      subscriptionQueryVariables = _h === void 0 ? {} : _h,\n      _j = options.deltaQuery,\n      _k = _j === void 0 ? {} : _j,\n      _l = _k.query,\n      deltaQueryQuery = _l === void 0 ? null : _l,\n      _m = _k.variables,\n      deltaQueryVariables = _m === void 0 ? {} : _m;\n\n  var baseQuery = baseQueryQuery ? {\n    query: graphql_1.print(baseQueryQuery),\n    variables: baseQueryVariables\n  } : {};\n  var subscriptionQuery = subscriptionQueryQuery ? {\n    query: graphql_1.print(subscriptionQueryQuery),\n    variables: subscriptionQueryVariables\n  } : {};\n  var deltaQuery = deltaQueryQuery ? {\n    query: graphql_1.print(deltaQueryQuery),\n    variables: deltaQueryVariables\n  } : {};\n  return utils_1.hash(JSON.stringify({\n    baseQuery: baseQuery,\n    subscriptionQuery: subscriptionQuery,\n    deltaQuery: deltaQuery\n  }));\n}; //#endregion\n//#region Redux\n\n\nvar effect = function (store, client, effect, _action, _offlineCallback, offlineStatusChangeObservable) {\n  return __awaiter(void 0, void 0, void 0, function () {\n    var options, _a, baseQuery, subscriptionQuery, deltaQuery, observer, _b, callback, upperBoundTimeMS, hash, itemInHash, _c, lastSyncTimestamp, _d, baseLastSyncTimestamp, networkStatusSubscription, subscription, baseQueryTimeoutId, subscriptionProcessor, unsubscribeAll, enqueueAgain, handle, STOP_CACHE_RECORDING, recorderCacheWrites, cacheProxy, error_2, _e, _f, _g, idsMap_1, cacheSnapshot, enquededMutations, subsControlLogger_1, baseRefreshIntervalInSeconds, skipBaseQuery, query, update_1, variables, result_1, _h, cacheSnapshot_1, data, query, update_2, variables, result_2, dataStore_1, enqueuedActionsFilter_1, baseQueryTimeout, error_1;\n\n    return __generator(this, function (_j) {\n      switch (_j.label) {\n        case 0:\n          options = effect.options, _a = effect.options, baseQuery = _a.baseQuery, subscriptionQuery = _a.subscriptionQuery, deltaQuery = _a.deltaQuery, observer = effect.observer, _b = effect.callback, callback = _b === void 0 ? function () {} : _b;\n\n          if (!observer || typeof observer.next !== 'function' || observer.closed) {\n            // If we don't have an observer, we complete this effect (this means the app was closed/opened and a completely \n            // new deltaSync will happen)\n            return [2\n            /*return*/\n            ];\n          }\n\n          upperBoundTimeMS = DEFAULT_UPPER_BOUND_TIME_MS;\n          hash = exports.hashForOptions(options);\n          itemInHash = store.getState()[offline_cache_1.METADATA_KEY][exports.DELTASYNC_KEY].metadata[hash];\n          _c = options.lastSyncTimestamp, lastSyncTimestamp = _c === void 0 ? itemInHash.lastSyncTimestamp : _c, _d = options.baseLastSyncTimestamp, baseLastSyncTimestamp = _d === void 0 ? itemInHash.baseLastSyncTimestamp : _d;\n\n          unsubscribeAll = function () {\n            logger('Unsubscribing');\n            if (networkStatusSubscription) networkStatusSubscription.unsubscribe();\n            if (subscription) subscription.unsubscribe();\n            if (baseQueryTimeoutId) clearTimeout(baseQueryTimeoutId);\n            if (subscriptionProcessor) subscriptionProcessor.close();\n          };\n\n          enqueueAgain = function () {\n            unsubscribeAll();\n            logger('Re-queuing', {\n              baseLastSyncTimestamp: baseLastSyncTimestamp,\n              lastSyncTimestamp: lastSyncTimestamp\n            });\n            exports.boundEnqueueDeltaSync(store, __assign(__assign({}, options), {\n              lastSyncTimestamp: lastSyncTimestamp,\n              baseLastSyncTimestamp: baseLastSyncTimestamp\n            }), observer, callback);\n          };\n\n          if (typeof callback === 'function') {\n            handle = new apollo_link_1.Observable(function () {\n              return function () {\n                return unsubscribeAll();\n              };\n            }).subscribe({\n              next: function () {}\n            });\n            callback(handle);\n          }\n\n          networkStatusSubscription = new apollo_link_1.Observable(function (obs) {\n            var handle = offlineStatusChangeObservable.subscribe({\n              next: function (_a) {\n                var online = _a.online;\n\n                if (!online) {\n                  obs.next(null);\n                  obs.complete();\n                }\n              },\n              complete: function () {\n                return obs.complete();\n              }\n            });\n            return function () {\n              return handle.unsubscribe();\n            };\n          }).subscribe({\n            next: function () {\n              enqueueAgain();\n            }\n          });\n          STOP_CACHE_RECORDING = typeof Symbol !== 'undefined' ? Symbol('stopCacheRecording') : '@@stopCacheRecording';\n          recorderCacheWrites = [];\n          cacheProxy = new Proxy(client.cache, {\n            get: function (target, name, receiver) {\n              switch (name) {\n                case 'write':\n                  return function (options) {\n                    if (!receiver[STOP_CACHE_RECORDING]) {\n                      recorderCacheWrites.push(options);\n                    }\n\n                    return target[name](options);\n                  };\n              }\n\n              return target[name];\n            }\n          });\n          subscriptionProcessor = subscriptionMessagesProcessorCreator(cacheProxy, function (proxy, record) {\n            var update = options.subscriptionQuery.update;\n\n            if (typeof update === 'function') {\n              update(proxy, record);\n              client.queryManager.broadcastQueries();\n            }\n          });\n          _j.label = 1;\n\n        case 1:\n          _j.trys.push([1, 8,, 9]);\n\n          _e = store.getState(), _f = offline_cache_1.METADATA_KEY, _g = _e[_f], idsMap_1 = _g.idsMap, cacheSnapshot = _g.snapshot.cache, enquededMutations = _e.offline.outbox;\n          subsControlLogger_1 = logger.extend('subsc-control');\n          return [4\n          /*yield*/\n          , new Promise(function (resolve) {\n            var _a;\n\n            if (subscriptionQuery && subscriptionQuery.query) {\n              var query = subscriptionQuery.query,\n                  variables = subscriptionQuery.variables;\n              subscription = client.subscribe({\n                query: query,\n                variables: __assign(__assign({}, variables), (_a = {}, _a[retry_link_1.SKIP_RETRY_KEY] = true, _a[aws_appsync_subscription_link_1.CONTROL_EVENTS_KEY] = true, _a))\n              }).filter(function (data) {\n                var _a = data.extensions,\n                    _b = _a === void 0 ? {} : _a,\n                    _c = _b.controlMsgType,\n                    controlMsgType = _c === void 0 ? undefined : _c,\n                    _d = _b.controlMsgInfo,\n                    controlMsgInfo = _d === void 0 ? undefined : _d;\n\n                var isControlMsg = typeof controlMsgType !== 'undefined';\n\n                if (controlMsgType) {\n                  subsControlLogger_1(controlMsgType, controlMsgInfo);\n\n                  if (controlMsgType === 'CONNECTED') {\n                    resolve();\n                  }\n                }\n\n                return !isControlMsg;\n              }).subscribe({\n                next: function (data) {\n                  subscriptionProcessor.enqueue(data);\n                },\n                error: function (err) {\n                  resolve();\n                  error_2 = err;\n                  unsubscribeAll();\n\n                  if (apollo_utilities_1.graphQLResultHasError(err) || err.graphQLErrors) {\n                    // send error to observable, unsubscribe all, do not enqueue\n                    observer.error(err);\n                    return;\n                  }\n\n                  enqueueAgain();\n                }\n              });\n            } else {\n              resolve();\n            }\n          })];\n\n        case 2:\n          _j.sent();\n\n          if (error_2) {\n            throw error_2;\n          }\n\n          baseRefreshIntervalInSeconds = (baseQuery || {\n            baseRefreshIntervalInSeconds: undefined\n          }).baseRefreshIntervalInSeconds;\n          upperBoundTimeMS = baseRefreshIntervalInSeconds ? baseRefreshIntervalInSeconds * 1000 : DEFAULT_UPPER_BOUND_TIME_MS;\n          skipBaseQuery = !(baseQuery && baseQuery.query) || (baseLastSyncTimestamp ? Date.now() - baseLastSyncTimestamp < upperBoundTimeMS : itemInHash.baseLastSyncTimestamp && Date.now() - itemInHash.baseLastSyncTimestamp < upperBoundTimeMS);\n          if (!(baseQuery && baseQuery.query)) return [3\n          /*break*/\n          , 5];\n          query = baseQuery.query, update_1 = baseQuery.update, variables = baseQuery.variables;\n          logger((skipBaseQuery ? 'Skipping' : 'Running') + \" base query\", {\n            baseLastSyncTimestamp: baseLastSyncTimestamp,\n            itemInHash: itemInHash\n          });\n          if (!!skipBaseQuery) return [3\n          /*break*/\n          , 4];\n          return [4\n          /*yield*/\n          , client.query({\n            fetchPolicy: 'no-cache',\n            query: query,\n            variables: variables\n          })];\n\n        case 3:\n          result_1 = _j.sent();\n          cacheProxy.writeQuery({\n            query: query,\n            variables: variables,\n            data: result_1.data\n          });\n\n          if (typeof update_1 === 'function') {\n            apollo_utilities_1.tryFunctionOrLogError(function () {\n              update_1(cacheProxy, result_1);\n            });\n          }\n\n          baseLastSyncTimestamp = Date.now() - BUFFER_MILLISECONDS;\n          boundUpdateLastSync(store, {\n            hash: hash,\n            baseLastSyncTimestamp: baseLastSyncTimestamp\n          });\n          return [3\n          /*break*/\n          , 5];\n\n        case 4:\n          try {\n            if (enquededMutations.length === 1) {\n              offline_link_1.boundSaveSnapshot(store, client.cache);\n            }\n\n            _h = offline_cache_1.METADATA_KEY, cacheSnapshot_1 = store.getState()[_h].snapshot.cache;\n            data = cacheProxy.storeReader.readQueryFromStore({\n              store: apollo_cache_inmemory_1.defaultNormalizedCacheFactory(cacheSnapshot_1),\n              query: apollo_utilities_1.addTypenameToDocument(query),\n              variables: variables\n            });\n            cacheProxy.writeQuery({\n              query: query,\n              variables: variables,\n              data: data\n            });\n          } catch (error) {\n            logger('Error reading/writting baseQuery from store', error);\n          }\n\n          _j.label = 5;\n\n        case 5:\n          //#endregion\n          //#region Delta query\n          if (deltaQuery && deltaQuery.query && !skipBaseQuery) {\n            logger('Skipping deltaQuery');\n          }\n\n          if (!(deltaQuery && deltaQuery.query && skipBaseQuery)) return [3\n          /*break*/\n          , 7];\n          query = deltaQuery.query, update_2 = deltaQuery.update, variables = deltaQuery.variables;\n          logger('Running deltaQuery', {\n            lastSyncTimestamp: lastSyncTimestamp,\n            baseLastSyncTimestamp: baseLastSyncTimestamp\n          });\n          return [4\n          /*yield*/\n          , client.query({\n            fetchPolicy: 'no-cache',\n            query: query,\n            variables: __assign(__assign({}, variables), {\n              lastSync: Math.floor((lastSyncTimestamp || baseLastSyncTimestamp) / 1000) || 0\n            })\n          })];\n\n        case 6:\n          result_2 = _j.sent();\n\n          if (typeof update_2 === 'function') {\n            apollo_utilities_1.tryFunctionOrLogError(function () {\n              update_2(cacheProxy, result_2);\n            });\n          }\n\n          lastSyncTimestamp = Date.now() - BUFFER_MILLISECONDS;\n          boundUpdateLastSync(store, {\n            hash: hash,\n            lastSyncTimestamp: lastSyncTimestamp\n          });\n          _j.label = 7;\n\n        case 7:\n          //#endregion\n          if (error_2) {\n            throw error_2;\n          } // process subscription messages\n\n\n          subscriptionProcessor.ready();\n          cacheProxy[STOP_CACHE_RECORDING] = true;\n\n          if (enquededMutations.length === 1) {\n            offline_link_1.boundSaveSnapshot(store, client.cache);\n          } else {\n            // Restore from cache snapshot\n            client.cache.restore(cacheSnapshot);\n          }\n\n          recorderCacheWrites.forEach(client.cache.write.bind(client.cache));\n          offline_link_1.boundSaveSnapshot(store, client.cache);\n          client.initQueryManager();\n          dataStore_1 = client.queryManager.dataStore;\n          enqueuedActionsFilter_1 = [offline_link_1.offlineEffectConfig.enqueueAction];\n          enquededMutations.filter(function (_a) {\n            var type = _a.type;\n            return enqueuedActionsFilter_1.indexOf(type) > -1;\n          }).forEach(function (_a) {\n            var effect = _a.meta.offline.effect;\n\n            var _b = effect,\n                _c = _b.operation,\n                _d = _c === void 0 ? {} : _c,\n                _e = _d.variables,\n                variables = _e === void 0 ? {} : _e,\n                _f = _d.query,\n                document = _f === void 0 ? null : _f,\n                update = _b.update,\n                origOptimisticResponse = _b.optimisticResponse;\n\n            if (typeof update !== 'function') {\n              return;\n            }\n\n            var optimisticResponse = offline_link_1.replaceUsingMap(__assign({}, origOptimisticResponse), idsMap_1);\n            var result = {\n              data: optimisticResponse\n            };\n            dataStore_1.markMutationResult({\n              mutationId: null,\n              result: result,\n              document: document,\n              variables: variables,\n              updateQueries: {},\n              update: update\n            });\n          });\n          client.queryManager.broadcastQueries();\n\n          if (baseQuery && baseQuery.query) {\n            baseQueryTimeout = Math.max(upperBoundTimeMS - (Date.now() - baseLastSyncTimestamp), MIN_UPPER_BOUND_TIME_MS);\n            logger(\"Re-running in \" + baseQueryTimeout / 1000 / 60 + \" minutes\");\n            baseQueryTimeoutId = global.setTimeout(function () {\n              return enqueueAgain();\n            }, baseQueryTimeout);\n          }\n\n          return [3\n          /*break*/\n          , 9];\n\n        case 8:\n          error_1 = _j.sent();\n          unsubscribeAll();\n          throw error_1;\n\n        case 9:\n          return [2\n          /*return*/\n          ];\n      }\n    });\n  });\n};\n\nvar discard = function (_callback, error, action, retries) {\n  var effect = action.meta.offline.effect;\n  var observer = effect.observer;\n\n  if (observer && observer.error && !observer.closed) {\n    observer.error(error);\n  }\n\n  return true;\n};\n\nvar reducer = function () {\n  return function (state, action) {\n    var _a;\n\n    switch (action.type) {\n      case actions.UPDATE_LASTSYNC:\n        logger(action.type, action.payload);\n        return lastSyncReducer(state, action);\n\n      case actions.ENQUEUE:\n        logger(action.type, action.meta.offline.effect.options);\n        return metadataReducer(state, action);\n\n      default:\n        var newState = __assign(__assign({}, state), (_a = {}, _a[exports.DELTASYNC_KEY] = __assign({\n          metadata: {}\n        }, state.deltaSync), _a));\n\n        return newState;\n    }\n  };\n};\n\nvar lastSyncReducer = function (state, action) {\n  var _a, _b;\n\n  var _c = action.payload,\n      lastSyncTimestamp = _c.lastSyncTimestamp,\n      hash = _c.hash,\n      baseLastSyncTimestamp = _c.baseLastSyncTimestamp;\n\n  var _d = state[exports.DELTASYNC_KEY],\n      metadata = _d.metadata,\n      deltaSync = __rest(_d, [\"metadata\"]);\n\n  var _e = hash,\n      hashMetadata = metadata[_e],\n      otherHashes = __rest(metadata, [typeof _e === \"symbol\" ? _e : _e + \"\"]);\n\n  var newMetadata = {\n    baseLastSyncTimestamp: baseLastSyncTimestamp || hashMetadata.baseLastSyncTimestamp,\n    lastSyncTimestamp: lastSyncTimestamp\n  };\n\n  var newState = __assign(__assign({}, state), (_a = {}, _a[exports.DELTASYNC_KEY] = __assign(__assign({}, deltaSync), {\n    metadata: __assign(__assign({}, otherHashes), (_b = {}, _b[hash] = newMetadata, _b))\n  }), _a));\n\n  return newState;\n};\n\nvar metadataReducer = function (state, action) {\n  var _a, _b;\n\n  var effect = action.meta.offline.effect;\n  var options = effect.options;\n  var metadata = state[exports.DELTASYNC_KEY].metadata;\n  var hash = exports.hashForOptions(options);\n  var hashMetadata = metadata[hash];\n\n  var _c = hashMetadata || {},\n      _d = _c.lastSyncTimestamp,\n      lastSyncTimestamp = _d === void 0 ? options.lastSyncTimestamp : _d,\n      _e = _c.baseLastSyncTimestamp,\n      baseLastSyncTimestamp = _e === void 0 ? options.baseLastSyncTimestamp : _e;\n\n  var newMetadata = {\n    lastSyncTimestamp: lastSyncTimestamp,\n    baseLastSyncTimestamp: options.baseLastSyncTimestamp === null ? null : baseLastSyncTimestamp\n  };\n\n  var newState = __assign(__assign({}, state), (_a = {}, _a[exports.DELTASYNC_KEY] = {\n    metadata: __assign(__assign({}, metadata), (_b = {}, _b[hash] = newMetadata, _b))\n  }, _a));\n\n  return newState;\n};\n\nexports.boundEnqueueDeltaSync = function (store, options, observer, callback) {\n  var effect = {\n    options: options,\n    observer: observer,\n    callback: callback\n  };\n  store.dispatch({\n    type: exports.offlineEffectConfig.enqueueAction,\n    meta: {\n      offline: {\n        effect: effect\n      }\n    }\n  });\n};\n\nvar boundUpdateLastSync = function (store, _a) {\n  var hash = _a.hash,\n      lastSyncTimestamp = _a.lastSyncTimestamp,\n      baseLastSyncTimestamp = _a.baseLastSyncTimestamp;\n  var action = {\n    type: actions.UPDATE_LASTSYNC,\n    payload: {\n      hash: hash,\n      lastSyncTimestamp: lastSyncTimestamp,\n      baseLastSyncTimestamp: baseLastSyncTimestamp\n    }\n  };\n  store.dispatch(action);\n}; //#endregion\n//#region Builder\n\n\nexports.buildSync = function (typename, options, idField) {\n  if (idField === void 0) {\n    idField = 'id';\n  }\n\n  var baseQuery = options.baseQuery,\n      subscriptionQuery = options.subscriptionQuery,\n      deltaQuery = options.deltaQuery,\n      _a = options.cacheUpdates,\n      cacheUpdates = _a === void 0 ? function () {\n    return [];\n  } : _a;\n  var loggerHelper = logger.extend('helper');\n  var result = {\n    baseQuery: __assign(__assign({}, baseQuery), baseQuery && {\n      update: function (cache, _a) {\n        var data = _a.data;\n        var opFieldName = utils_1.getOperationFieldName(baseQuery.query);\n        var _b = opFieldName,\n            result = data[_b];\n        writeCacheUpdates(loggerHelper, cache, result, cacheUpdates);\n      }\n    }),\n    subscriptionQuery: __assign(__assign({}, subscriptionQuery), subscriptionQuery && {\n      update: function (cache, _a) {\n        var data = _a.data;\n        updateBaseWithDelta(loggerHelper, baseQuery, subscriptionQuery, cache, data, cacheUpdates, typename, idField);\n      }\n    }),\n    deltaQuery: __assign(__assign({}, deltaQuery), deltaQuery && {\n      update: function (cache, _a) {\n        var data = _a.data;\n        updateBaseWithDelta(loggerHelper, baseQuery, deltaQuery, cache, data, cacheUpdates, typename, idField);\n      }\n    })\n  };\n  loggerHelper('buildSync options', result);\n  return result;\n};\n\nvar writeCacheUpdates = function (logger, cache, result, cacheUpdates) {\n  if (cacheUpdates === void 0) {\n    cacheUpdates = function () {\n      return [];\n    };\n  }\n\n  var cacheUpdatesLogger = logger.extend('cacheUpdates');\n  cacheUpdatesLogger('writeCacheUpdates');\n  result.forEach(function (item) {\n    return cacheUpdates(item).forEach(function (_a) {\n      var _b;\n\n      var query = _a.query,\n          variables = _a.variables;\n      var opFieldName = utils_1.getOperationFieldName(query);\n      var data = (_b = {}, _b[opFieldName] = item, _b);\n      cacheUpdatesLogger(\"Writing \" + opFieldName, {\n        variables: variables,\n        data: data\n      });\n      cache.writeQuery({\n        query: query,\n        variables: variables,\n        data: data\n      });\n    });\n  });\n};\n\nvar deltaRecordsProcessor = function (logger, deltaOperationName, deltaRecords, baseResult, typename, idField) {\n  var opType = offline_1.getOpTypeFromOperationName(deltaOperationName);\n  logger({\n    deltaOperationName: deltaOperationName,\n    opType: opType,\n    deltaRecords: deltaRecords\n  });\n\n  if (!deltaRecords.length) {\n    return baseResult;\n  }\n\n  var result = __spreadArrays(baseResult);\n\n  deltaRecords.forEach(function (deltaRecord) {\n    var incomingRecord = __assign(__assign({}, deltaRecord), {\n      __typename: typename\n    });\n\n    var isRemove = opType === offline_1.CacheOperationTypes.REMOVE || incomingRecord.aws_ds === 'DELETE';\n    var updater = offline_1.getUpdater(opType === offline_1.CacheOperationTypes.AUTO && !isRemove ? offline_1.CacheOperationTypes.ADD : isRemove ? offline_1.CacheOperationTypes.REMOVE : opType, idField);\n    logger({\n      incomingRecord: incomingRecord,\n      isRemove: isRemove\n    });\n    result = updater(__spreadArrays(result), incomingRecord);\n  });\n  return result;\n};\n\nvar updateBaseWithDelta = function (logger, baseQuery, otherQuery, cache, data, cacheUpdates, typename, idField) {\n  var _a;\n\n  if (cacheUpdates === void 0) {\n    cacheUpdates = function () {\n      return [];\n    };\n  }\n\n  if (idField === void 0) {\n    idField = 'id';\n  }\n\n  var updateLogger = logger.extend('update');\n  var opDefinition = apollo_utilities_1.getMainDefinition(otherQuery.query);\n  var _b = opDefinition.selectionSet.selections[0],\n      opName = _b.name.value,\n      opAliasNode = _b.alias;\n  var _c = (opAliasNode || {}).value,\n      opAlias = _c === void 0 ? null : _c;\n  var _d = opDefinition,\n      kind = _d.kind,\n      graphqlOperation = _d.operation;\n  var isSubscription = kind === 'OperationDefinition' && graphqlOperation === 'subscription';\n  var deltaOperationName = (isSubscription ? Object.keys(data) : [opAlias || opName])[0];\n  var _e = deltaOperationName,\n      records = data[_e];\n  var deltaRecords = [].concat(records);\n\n  if (!baseQuery || !baseQuery.query) {\n    updateLogger('No baseQuery provided');\n  } else {\n    var query = baseQuery.query,\n        variables = baseQuery.variables;\n    var operationName = utils_1.getOperationFieldName(query);\n\n    var _f = operationName,\n        baseResult = cache.readQuery({\n      query: query,\n      variables: variables\n    })[_f];\n\n    if (!Array.isArray(baseResult)) {\n      throw new Error('Result of baseQuery is not an array');\n    }\n\n    var result = deltaRecordsProcessor(updateLogger, deltaOperationName, deltaRecords, baseResult, typename, idField);\n\n    if (result !== baseResult) {\n      cache.writeQuery({\n        query: query,\n        data: (_a = {}, _a[operationName] = result, _a)\n      });\n    }\n  }\n\n  writeCacheUpdates(updateLogger, cache, deltaRecords, cacheUpdates);\n}; //#endregion\n\n\nexports.offlineEffectConfig = {\n  enqueueAction: actions.ENQUEUE,\n  effect: effect,\n  discard: discard,\n  reducer: reducer\n};","map":{"version":3,"names":["__assign","Object","assign","t","s","i","n","arguments","length","p","prototype","hasOwnProperty","call","apply","__awaiter","thisArg","_arguments","P","generator","adopt","value","resolve","Promise","reject","fulfilled","step","next","e","rejected","result","done","then","__generator","body","_","label","sent","trys","ops","f","y","g","verb","Symbol","iterator","v","op","TypeError","pop","push","__rest","indexOf","getOwnPropertySymbols","propertyIsEnumerable","__spreadArrays","il","r","Array","k","a","j","jl","defineProperty","exports","apollo_cache_inmemory_1","require","offline_cache_1","apollo_utilities_1","utils_1","apollo_link_1","retry_link_1","graphql_1","offline_1","offline_link_1","aws_appsync_subscription_link_1","logger","rootLogger","extend","DELTASYNC_KEY","actions","ENQUEUE","UPDATE_LASTSYNC","DEFAULT_UPPER_BOUND_TIME_MS","MIN_UPPER_BOUND_TIME_MS","BUFFER_MILLISECONDS","subscriptionMessagesProcessorCreator","proxy","updateFunction","buffer","ready","wrappedUpdateFunction","record","tryFunctionOrLogError","processor","enqueue","forEach","close","hashForOptions","options","_a","baseQuery","_b","_c","query","baseQueryQuery","_d","variables","baseQueryVariables","_e","subscriptionQuery","_f","_g","subscriptionQueryQuery","_h","subscriptionQueryVariables","_j","deltaQuery","_k","_l","deltaQueryQuery","_m","deltaQueryVariables","print","hash","JSON","stringify","effect","store","client","_action","_offlineCallback","offlineStatusChangeObservable","observer","callback","upperBoundTimeMS","itemInHash","lastSyncTimestamp","baseLastSyncTimestamp","networkStatusSubscription","subscription","baseQueryTimeoutId","subscriptionProcessor","unsubscribeAll","enqueueAgain","handle","STOP_CACHE_RECORDING","recorderCacheWrites","cacheProxy","error_2","idsMap_1","cacheSnapshot","enquededMutations","subsControlLogger_1","baseRefreshIntervalInSeconds","skipBaseQuery","update_1","result_1","cacheSnapshot_1","data","update_2","result_2","dataStore_1","enqueuedActionsFilter_1","baseQueryTimeout","error_1","closed","getState","METADATA_KEY","metadata","unsubscribe","clearTimeout","boundEnqueueDeltaSync","Observable","subscribe","obs","online","complete","Proxy","cache","get","target","name","receiver","update","queryManager","broadcastQueries","idsMap","snapshot","offline","outbox","SKIP_RETRY_KEY","CONTROL_EVENTS_KEY","filter","extensions","controlMsgType","undefined","controlMsgInfo","isControlMsg","error","err","graphQLResultHasError","graphQLErrors","Date","now","fetchPolicy","writeQuery","boundUpdateLastSync","boundSaveSnapshot","storeReader","readQueryFromStore","defaultNormalizedCacheFactory","addTypenameToDocument","lastSync","Math","floor","restore","write","bind","initQueryManager","dataStore","offlineEffectConfig","enqueueAction","type","meta","operation","document","origOptimisticResponse","optimisticResponse","replaceUsingMap","markMutationResult","mutationId","updateQueries","max","global","setTimeout","discard","_callback","action","retries","reducer","state","payload","lastSyncReducer","metadataReducer","newState","deltaSync","hashMetadata","otherHashes","newMetadata","dispatch","buildSync","typename","idField","cacheUpdates","loggerHelper","opFieldName","getOperationFieldName","writeCacheUpdates","updateBaseWithDelta","cacheUpdatesLogger","item","deltaRecordsProcessor","deltaOperationName","deltaRecords","baseResult","opType","getOpTypeFromOperationName","deltaRecord","incomingRecord","__typename","isRemove","CacheOperationTypes","REMOVE","aws_ds","updater","getUpdater","AUTO","ADD","otherQuery","updateLogger","opDefinition","getMainDefinition","selectionSet","selections","opName","opAliasNode","alias","opAlias","kind","graphqlOperation","isSubscription","keys","records","concat","operationName","readQuery","isArray","Error"],"sources":["/Users/roaldmaravillas/ro/github/scaffold-appsync-events/node_modules/aws-appsync/lib/deltaSync.js"],"sourcesContent":["\"use strict\";\nvar __assign = (this && this.__assign) || function () {\n    __assign = Object.assign || function(t) {\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\n            s = arguments[i];\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n                t[p] = s[p];\n        }\n        return t;\n    };\n    return __assign.apply(this, arguments);\n};\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nvar __rest = (this && this.__rest) || function (s, e) {\n    var t = {};\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\n        t[p] = s[p];\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\n                t[p[i]] = s[p[i]];\n        }\n    return t;\n};\nvar __spreadArrays = (this && this.__spreadArrays) || function () {\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\n            r[k] = a[j];\n    return r;\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar apollo_cache_inmemory_1 = require(\"apollo-cache-inmemory\");\nvar offline_cache_1 = require(\"./cache/offline-cache\");\nvar apollo_utilities_1 = require(\"apollo-utilities\");\nvar utils_1 = require(\"./utils\");\nvar apollo_link_1 = require(\"apollo-link\");\nvar retry_link_1 = require(\"./link/retry-link\");\nvar graphql_1 = require(\"graphql\");\nvar offline_1 = require(\"./helpers/offline\");\nvar offline_link_1 = require(\"./link/offline-link\");\nvar aws_appsync_subscription_link_1 = require(\"aws-appsync-subscription-link\");\nvar logger = utils_1.rootLogger.extend('deltasync');\nexports.DELTASYNC_KEY = 'deltaSync';\n//#endregion\n//#region Constants\nvar actions = {\n    ENQUEUE: 'DELTASYNC_ENQUEUE_RECONNECT',\n    UPDATE_LASTSYNC: 'DELTASYNC_UPDATE_LASTSYNC',\n};\nvar DEFAULT_UPPER_BOUND_TIME_MS = 24 * 60 * 60 * 1000;\nvar MIN_UPPER_BOUND_TIME_MS = 2 * 1000;\nvar BUFFER_MILLISECONDS = 2000;\n//#endregion\n//#region helpers\nvar subscriptionMessagesProcessorCreator = function (proxy, updateFunction) {\n    var buffer = [];\n    var ready = false;\n    var wrappedUpdateFunction = function (proxy, record) { return apollo_utilities_1.tryFunctionOrLogError(function () { return updateFunction(proxy, record); }); };\n    var processor = {\n        enqueue: function (record) {\n            if (ready) {\n                wrappedUpdateFunction(proxy, record);\n                return;\n            }\n            buffer.push(record);\n        },\n        ready: function () {\n            if (ready) {\n                return;\n            }\n            buffer.forEach(function (record) { return wrappedUpdateFunction(proxy, record); });\n            buffer = [];\n            ready = true;\n        },\n        close: function () {\n            buffer = [];\n            ready = true;\n        }\n    };\n    return processor;\n};\nexports.hashForOptions = function (options) {\n    var _a = options.baseQuery, _b = _a === void 0 ? {} : _a, _c = _b.query, baseQueryQuery = _c === void 0 ? null : _c, _d = _b.variables, baseQueryVariables = _d === void 0 ? {} : _d, _e = options.subscriptionQuery, _f = _e === void 0 ? {} : _e, _g = _f.query, subscriptionQueryQuery = _g === void 0 ? null : _g, _h = _f.variables, subscriptionQueryVariables = _h === void 0 ? {} : _h, _j = options.deltaQuery, _k = _j === void 0 ? {} : _j, _l = _k.query, deltaQueryQuery = _l === void 0 ? null : _l, _m = _k.variables, deltaQueryVariables = _m === void 0 ? {} : _m;\n    var baseQuery = baseQueryQuery ? {\n        query: graphql_1.print(baseQueryQuery),\n        variables: baseQueryVariables,\n    } : {};\n    var subscriptionQuery = subscriptionQueryQuery ? {\n        query: graphql_1.print(subscriptionQueryQuery),\n        variables: subscriptionQueryVariables,\n    } : {};\n    var deltaQuery = deltaQueryQuery ? {\n        query: graphql_1.print(deltaQueryQuery),\n        variables: deltaQueryVariables,\n    } : {};\n    return utils_1.hash(JSON.stringify({\n        baseQuery: baseQuery,\n        subscriptionQuery: subscriptionQuery,\n        deltaQuery: deltaQuery,\n    }));\n};\n//#endregion\n//#region Redux\nvar effect = function (store, client, effect, _action, _offlineCallback, offlineStatusChangeObservable) { return __awaiter(void 0, void 0, void 0, function () {\n    var options, _a, baseQuery, subscriptionQuery, deltaQuery, observer, _b, callback, upperBoundTimeMS, hash, itemInHash, _c, lastSyncTimestamp, _d, baseLastSyncTimestamp, networkStatusSubscription, subscription, baseQueryTimeoutId, subscriptionProcessor, unsubscribeAll, enqueueAgain, handle, STOP_CACHE_RECORDING, recorderCacheWrites, cacheProxy, error_2, _e, _f, _g, idsMap_1, cacheSnapshot, enquededMutations, subsControlLogger_1, baseRefreshIntervalInSeconds, skipBaseQuery, query, update_1, variables, result_1, _h, cacheSnapshot_1, data, query, update_2, variables, result_2, dataStore_1, enqueuedActionsFilter_1, baseQueryTimeout, error_1;\n    return __generator(this, function (_j) {\n        switch (_j.label) {\n            case 0:\n                options = effect.options, _a = effect.options, baseQuery = _a.baseQuery, subscriptionQuery = _a.subscriptionQuery, deltaQuery = _a.deltaQuery, observer = effect.observer, _b = effect.callback, callback = _b === void 0 ? function () { } : _b;\n                if (!observer || typeof observer.next !== 'function' || observer.closed) {\n                    // If we don't have an observer, we complete this effect (this means the app was closed/opened and a completely \n                    // new deltaSync will happen)\n                    return [2 /*return*/];\n                }\n                upperBoundTimeMS = DEFAULT_UPPER_BOUND_TIME_MS;\n                hash = exports.hashForOptions(options);\n                itemInHash = store.getState()[offline_cache_1.METADATA_KEY][exports.DELTASYNC_KEY].metadata[hash];\n                _c = options.lastSyncTimestamp, lastSyncTimestamp = _c === void 0 ? itemInHash.lastSyncTimestamp : _c, _d = options.baseLastSyncTimestamp, baseLastSyncTimestamp = _d === void 0 ? itemInHash.baseLastSyncTimestamp : _d;\n                unsubscribeAll = function () {\n                    logger('Unsubscribing');\n                    if (networkStatusSubscription)\n                        networkStatusSubscription.unsubscribe();\n                    if (subscription)\n                        subscription.unsubscribe();\n                    if (baseQueryTimeoutId)\n                        clearTimeout(baseQueryTimeoutId);\n                    if (subscriptionProcessor)\n                        subscriptionProcessor.close();\n                };\n                enqueueAgain = function () {\n                    unsubscribeAll();\n                    logger('Re-queuing', { baseLastSyncTimestamp: baseLastSyncTimestamp, lastSyncTimestamp: lastSyncTimestamp });\n                    exports.boundEnqueueDeltaSync(store, __assign(__assign({}, options), { lastSyncTimestamp: lastSyncTimestamp, baseLastSyncTimestamp: baseLastSyncTimestamp }), observer, callback);\n                };\n                if (typeof callback === 'function') {\n                    handle = new apollo_link_1.Observable(function () { return function () { return unsubscribeAll(); }; }).subscribe({ next: function () { } });\n                    callback(handle);\n                }\n                networkStatusSubscription = new apollo_link_1.Observable(function (obs) {\n                    var handle = offlineStatusChangeObservable.subscribe({\n                        next: function (_a) {\n                            var online = _a.online;\n                            if (!online) {\n                                obs.next(null);\n                                obs.complete();\n                            }\n                        },\n                        complete: function () { return obs.complete(); },\n                    });\n                    return function () { return handle.unsubscribe(); };\n                }).subscribe({\n                    next: function () {\n                        enqueueAgain();\n                    }\n                });\n                STOP_CACHE_RECORDING = typeof Symbol !== 'undefined' ? Symbol('stopCacheRecording') : '@@stopCacheRecording';\n                recorderCacheWrites = [];\n                cacheProxy = new Proxy(client.cache, {\n                    get: function (target, name, receiver) {\n                        switch (name) {\n                            case 'write':\n                                return function (options) {\n                                    if (!receiver[STOP_CACHE_RECORDING]) {\n                                        recorderCacheWrites.push(options);\n                                    }\n                                    return target[name](options);\n                                };\n                        }\n                        return target[name];\n                    }\n                });\n                subscriptionProcessor = subscriptionMessagesProcessorCreator(cacheProxy, function (proxy, record) {\n                    var update = options.subscriptionQuery.update;\n                    if (typeof update === 'function') {\n                        update(proxy, record);\n                        client.queryManager.broadcastQueries();\n                    }\n                });\n                _j.label = 1;\n            case 1:\n                _j.trys.push([1, 8, , 9]);\n                _e = store.getState(), _f = offline_cache_1.METADATA_KEY, _g = _e[_f], idsMap_1 = _g.idsMap, cacheSnapshot = _g.snapshot.cache, enquededMutations = _e.offline.outbox;\n                subsControlLogger_1 = logger.extend('subsc-control');\n                return [4 /*yield*/, new Promise(function (resolve) {\n                        var _a;\n                        if (subscriptionQuery && subscriptionQuery.query) {\n                            var query = subscriptionQuery.query, variables = subscriptionQuery.variables;\n                            subscription = client.subscribe({\n                                query: query,\n                                variables: __assign(__assign({}, variables), (_a = {}, _a[retry_link_1.SKIP_RETRY_KEY] = true, _a[aws_appsync_subscription_link_1.CONTROL_EVENTS_KEY] = true, _a)),\n                            }).filter(function (data) {\n                                var _a = data.extensions, _b = _a === void 0 ? {} : _a, _c = _b.controlMsgType, controlMsgType = _c === void 0 ? undefined : _c, _d = _b.controlMsgInfo, controlMsgInfo = _d === void 0 ? undefined : _d;\n                                var isControlMsg = typeof controlMsgType !== 'undefined';\n                                if (controlMsgType) {\n                                    subsControlLogger_1(controlMsgType, controlMsgInfo);\n                                    if (controlMsgType === 'CONNECTED') {\n                                        resolve();\n                                    }\n                                }\n                                return !isControlMsg;\n                            }).subscribe({\n                                next: function (data) {\n                                    subscriptionProcessor.enqueue(data);\n                                },\n                                error: function (err) {\n                                    resolve();\n                                    error_2 = err;\n                                    unsubscribeAll();\n                                    if (apollo_utilities_1.graphQLResultHasError(err) || err.graphQLErrors) {\n                                        // send error to observable, unsubscribe all, do not enqueue\n                                        observer.error(err);\n                                        return;\n                                    }\n                                    enqueueAgain();\n                                }\n                            });\n                        }\n                        else {\n                            resolve();\n                        }\n                    })];\n            case 2:\n                _j.sent();\n                if (error_2) {\n                    throw error_2;\n                }\n                baseRefreshIntervalInSeconds = (baseQuery || { baseRefreshIntervalInSeconds: undefined }).baseRefreshIntervalInSeconds;\n                upperBoundTimeMS = baseRefreshIntervalInSeconds ? baseRefreshIntervalInSeconds * 1000 : DEFAULT_UPPER_BOUND_TIME_MS;\n                skipBaseQuery = !(baseQuery && baseQuery.query) || (baseLastSyncTimestamp\n                    ? Date.now() - baseLastSyncTimestamp < upperBoundTimeMS\n                    : itemInHash.baseLastSyncTimestamp && Date.now() - itemInHash.baseLastSyncTimestamp < upperBoundTimeMS);\n                if (!(baseQuery && baseQuery.query)) return [3 /*break*/, 5];\n                query = baseQuery.query, update_1 = baseQuery.update, variables = baseQuery.variables;\n                logger((skipBaseQuery ? 'Skipping' : 'Running') + \" base query\", { baseLastSyncTimestamp: baseLastSyncTimestamp, itemInHash: itemInHash });\n                if (!!skipBaseQuery) return [3 /*break*/, 4];\n                return [4 /*yield*/, client.query({\n                        fetchPolicy: 'no-cache',\n                        query: query,\n                        variables: variables,\n                    })];\n            case 3:\n                result_1 = _j.sent();\n                cacheProxy.writeQuery({ query: query, variables: variables, data: result_1.data });\n                if (typeof update_1 === 'function') {\n                    apollo_utilities_1.tryFunctionOrLogError(function () {\n                        update_1(cacheProxy, result_1);\n                    });\n                }\n                baseLastSyncTimestamp = Date.now() - BUFFER_MILLISECONDS;\n                boundUpdateLastSync(store, { hash: hash, baseLastSyncTimestamp: baseLastSyncTimestamp });\n                return [3 /*break*/, 5];\n            case 4:\n                try {\n                    if (enquededMutations.length === 1) {\n                        offline_link_1.boundSaveSnapshot(store, client.cache);\n                    }\n                    _h = offline_cache_1.METADATA_KEY, cacheSnapshot_1 = store.getState()[_h].snapshot.cache;\n                    data = cacheProxy.storeReader.readQueryFromStore({\n                        store: apollo_cache_inmemory_1.defaultNormalizedCacheFactory(cacheSnapshot_1),\n                        query: apollo_utilities_1.addTypenameToDocument(query),\n                        variables: variables,\n                    });\n                    cacheProxy.writeQuery({ query: query, variables: variables, data: data });\n                }\n                catch (error) {\n                    logger('Error reading/writting baseQuery from store', error);\n                }\n                _j.label = 5;\n            case 5:\n                //#endregion\n                //#region Delta query\n                if (deltaQuery && deltaQuery.query && !skipBaseQuery) {\n                    logger('Skipping deltaQuery');\n                }\n                if (!(deltaQuery && deltaQuery.query && skipBaseQuery)) return [3 /*break*/, 7];\n                query = deltaQuery.query, update_2 = deltaQuery.update, variables = deltaQuery.variables;\n                logger('Running deltaQuery', { lastSyncTimestamp: lastSyncTimestamp, baseLastSyncTimestamp: baseLastSyncTimestamp });\n                return [4 /*yield*/, client.query({\n                        fetchPolicy: 'no-cache',\n                        query: query,\n                        variables: __assign(__assign({}, variables), { lastSync: Math.floor((lastSyncTimestamp || baseLastSyncTimestamp) / 1000) || 0 }),\n                    })];\n            case 6:\n                result_2 = _j.sent();\n                if (typeof update_2 === 'function') {\n                    apollo_utilities_1.tryFunctionOrLogError(function () {\n                        update_2(cacheProxy, result_2);\n                    });\n                }\n                lastSyncTimestamp = Date.now() - BUFFER_MILLISECONDS;\n                boundUpdateLastSync(store, { hash: hash, lastSyncTimestamp: lastSyncTimestamp });\n                _j.label = 7;\n            case 7:\n                //#endregion\n                if (error_2) {\n                    throw error_2;\n                }\n                // process subscription messages\n                subscriptionProcessor.ready();\n                cacheProxy[STOP_CACHE_RECORDING] = true;\n                if (enquededMutations.length === 1) {\n                    offline_link_1.boundSaveSnapshot(store, client.cache);\n                }\n                else {\n                    // Restore from cache snapshot\n                    client.cache.restore(cacheSnapshot);\n                }\n                recorderCacheWrites.forEach(client.cache.write.bind(client.cache));\n                offline_link_1.boundSaveSnapshot(store, client.cache);\n                client.initQueryManager();\n                dataStore_1 = client.queryManager.dataStore;\n                enqueuedActionsFilter_1 = [offline_link_1.offlineEffectConfig.enqueueAction];\n                enquededMutations\n                    .filter(function (_a) {\n                    var type = _a.type;\n                    return enqueuedActionsFilter_1.indexOf(type) > -1;\n                })\n                    .forEach(function (_a) {\n                    var effect = _a.meta.offline.effect;\n                    var _b = effect, _c = _b.operation, _d = _c === void 0 ? {} : _c, _e = _d.variables, variables = _e === void 0 ? {} : _e, _f = _d.query, document = _f === void 0 ? null : _f, update = _b.update, origOptimisticResponse = _b.optimisticResponse;\n                    if (typeof update !== 'function') {\n                        return;\n                    }\n                    var optimisticResponse = offline_link_1.replaceUsingMap(__assign({}, origOptimisticResponse), idsMap_1);\n                    var result = { data: optimisticResponse };\n                    dataStore_1.markMutationResult({\n                        mutationId: null,\n                        result: result,\n                        document: document,\n                        variables: variables,\n                        updateQueries: {},\n                        update: update\n                    });\n                });\n                client.queryManager.broadcastQueries();\n                if (baseQuery && baseQuery.query) {\n                    baseQueryTimeout = Math.max(upperBoundTimeMS - (Date.now() - baseLastSyncTimestamp), MIN_UPPER_BOUND_TIME_MS);\n                    logger(\"Re-running in \" + baseQueryTimeout / 1000 / 60 + \" minutes\");\n                    baseQueryTimeoutId = global.setTimeout(function () { return enqueueAgain(); }, baseQueryTimeout);\n                }\n                return [3 /*break*/, 9];\n            case 8:\n                error_1 = _j.sent();\n                unsubscribeAll();\n                throw error_1;\n            case 9: return [2 /*return*/];\n        }\n    });\n}); };\nvar discard = function (_callback, error, action, retries) {\n    var effect = action.meta.offline.effect;\n    var observer = effect.observer;\n    if (observer && observer.error && !observer.closed) {\n        observer.error(error);\n    }\n    return true;\n};\nvar reducer = function () { return function (state, action) {\n    var _a;\n    switch (action.type) {\n        case actions.UPDATE_LASTSYNC:\n            logger(action.type, action.payload);\n            return lastSyncReducer(state, action);\n        case actions.ENQUEUE:\n            logger(action.type, action.meta.offline.effect.options);\n            return metadataReducer(state, action);\n        default:\n            var newState = __assign(__assign({}, state), (_a = {}, _a[exports.DELTASYNC_KEY] = __assign({ metadata: {} }, state.deltaSync), _a));\n            return newState;\n    }\n}; };\nvar lastSyncReducer = function (state, action) {\n    var _a, _b;\n    var _c = action.payload, lastSyncTimestamp = _c.lastSyncTimestamp, hash = _c.hash, baseLastSyncTimestamp = _c.baseLastSyncTimestamp;\n    var _d = state[exports.DELTASYNC_KEY], metadata = _d.metadata, deltaSync = __rest(_d, [\"metadata\"]);\n    var _e = hash, hashMetadata = metadata[_e], otherHashes = __rest(metadata, [typeof _e === \"symbol\" ? _e : _e + \"\"]);\n    var newMetadata = {\n        baseLastSyncTimestamp: baseLastSyncTimestamp || hashMetadata.baseLastSyncTimestamp,\n        lastSyncTimestamp: lastSyncTimestamp,\n    };\n    var newState = __assign(__assign({}, state), (_a = {}, _a[exports.DELTASYNC_KEY] = __assign(__assign({}, deltaSync), { metadata: __assign(__assign({}, otherHashes), (_b = {}, _b[hash] = newMetadata, _b)) }), _a));\n    return newState;\n};\nvar metadataReducer = function (state, action) {\n    var _a, _b;\n    var effect = action.meta.offline.effect;\n    var options = effect.options;\n    var metadata = state[exports.DELTASYNC_KEY].metadata;\n    var hash = exports.hashForOptions(options);\n    var hashMetadata = metadata[hash];\n    var _c = hashMetadata || {}, _d = _c.lastSyncTimestamp, lastSyncTimestamp = _d === void 0 ? options.lastSyncTimestamp : _d, _e = _c.baseLastSyncTimestamp, baseLastSyncTimestamp = _e === void 0 ? options.baseLastSyncTimestamp : _e;\n    var newMetadata = {\n        lastSyncTimestamp: lastSyncTimestamp,\n        baseLastSyncTimestamp: options.baseLastSyncTimestamp === null ? null : baseLastSyncTimestamp,\n    };\n    var newState = __assign(__assign({}, state), (_a = {}, _a[exports.DELTASYNC_KEY] = {\n        metadata: __assign(__assign({}, metadata), (_b = {}, _b[hash] = newMetadata, _b))\n    }, _a));\n    return newState;\n};\nexports.boundEnqueueDeltaSync = function (store, options, observer, callback) {\n    var effect = { options: options, observer: observer, callback: callback };\n    store.dispatch({\n        type: exports.offlineEffectConfig.enqueueAction,\n        meta: {\n            offline: {\n                effect: effect\n            },\n        }\n    });\n};\nvar boundUpdateLastSync = function (store, _a) {\n    var hash = _a.hash, lastSyncTimestamp = _a.lastSyncTimestamp, baseLastSyncTimestamp = _a.baseLastSyncTimestamp;\n    var action = {\n        type: actions.UPDATE_LASTSYNC,\n        payload: {\n            hash: hash,\n            lastSyncTimestamp: lastSyncTimestamp,\n            baseLastSyncTimestamp: baseLastSyncTimestamp,\n        }\n    };\n    store.dispatch(action);\n};\n//#endregion\n//#region Builder\nexports.buildSync = function (typename, options, idField) {\n    if (idField === void 0) { idField = 'id'; }\n    var baseQuery = options.baseQuery, subscriptionQuery = options.subscriptionQuery, deltaQuery = options.deltaQuery, _a = options.cacheUpdates, cacheUpdates = _a === void 0 ? function () { return []; } : _a;\n    var loggerHelper = logger.extend('helper');\n    var result = {\n        baseQuery: __assign(__assign({}, baseQuery), (baseQuery && {\n            update: function (cache, _a) {\n                var data = _a.data;\n                var opFieldName = utils_1.getOperationFieldName(baseQuery.query);\n                var _b = opFieldName, result = data[_b];\n                writeCacheUpdates(loggerHelper, cache, result, cacheUpdates);\n            }\n        })),\n        subscriptionQuery: __assign(__assign({}, subscriptionQuery), (subscriptionQuery && {\n            update: function (cache, _a) {\n                var data = _a.data;\n                updateBaseWithDelta(loggerHelper, baseQuery, subscriptionQuery, cache, data, cacheUpdates, typename, idField);\n            }\n        })),\n        deltaQuery: __assign(__assign({}, deltaQuery), (deltaQuery && {\n            update: function (cache, _a) {\n                var data = _a.data;\n                updateBaseWithDelta(loggerHelper, baseQuery, deltaQuery, cache, data, cacheUpdates, typename, idField);\n            }\n        })),\n    };\n    loggerHelper('buildSync options', result);\n    return result;\n};\nvar writeCacheUpdates = function (logger, cache, result, cacheUpdates) {\n    if (cacheUpdates === void 0) { cacheUpdates = function () { return []; }; }\n    var cacheUpdatesLogger = logger.extend('cacheUpdates');\n    cacheUpdatesLogger('writeCacheUpdates');\n    result.forEach(function (item) { return cacheUpdates(item).forEach(function (_a) {\n        var _b;\n        var query = _a.query, variables = _a.variables;\n        var opFieldName = utils_1.getOperationFieldName(query);\n        var data = (_b = {}, _b[opFieldName] = item, _b);\n        cacheUpdatesLogger(\"Writing \" + opFieldName, { variables: variables, data: data });\n        cache.writeQuery({ query: query, variables: variables, data: data });\n    }); });\n};\nvar deltaRecordsProcessor = function (logger, deltaOperationName, deltaRecords, baseResult, typename, idField) {\n    var opType = offline_1.getOpTypeFromOperationName(deltaOperationName);\n    logger({ deltaOperationName: deltaOperationName, opType: opType, deltaRecords: deltaRecords });\n    if (!deltaRecords.length) {\n        return baseResult;\n    }\n    var result = __spreadArrays(baseResult);\n    deltaRecords.forEach(function (deltaRecord) {\n        var incomingRecord = __assign(__assign({}, deltaRecord), { __typename: typename });\n        var isRemove = opType === offline_1.CacheOperationTypes.REMOVE || incomingRecord.aws_ds === 'DELETE';\n        var updater = offline_1.getUpdater(opType === offline_1.CacheOperationTypes.AUTO && !isRemove\n            ? offline_1.CacheOperationTypes.ADD\n            : (isRemove ? offline_1.CacheOperationTypes.REMOVE : opType), idField);\n        logger({ incomingRecord: incomingRecord, isRemove: isRemove });\n        result = updater(__spreadArrays(result), incomingRecord);\n    });\n    return result;\n};\nvar updateBaseWithDelta = function (logger, baseQuery, otherQuery, cache, data, cacheUpdates, typename, idField) {\n    var _a;\n    if (cacheUpdates === void 0) { cacheUpdates = function () { return []; }; }\n    if (idField === void 0) { idField = 'id'; }\n    var updateLogger = logger.extend('update');\n    var opDefinition = apollo_utilities_1.getMainDefinition(otherQuery.query);\n    var _b = opDefinition.selectionSet.selections[0], opName = _b.name.value, opAliasNode = _b.alias;\n    var _c = (opAliasNode || {}).value, opAlias = _c === void 0 ? null : _c;\n    var _d = opDefinition, kind = _d.kind, graphqlOperation = _d.operation;\n    var isSubscription = kind === 'OperationDefinition' && graphqlOperation === 'subscription';\n    var deltaOperationName = (isSubscription ? Object.keys(data) : [opAlias || opName])[0];\n    var _e = deltaOperationName, records = data[_e];\n    var deltaRecords = [].concat(records);\n    if (!baseQuery || !baseQuery.query) {\n        updateLogger('No baseQuery provided');\n    }\n    else {\n        var query = baseQuery.query, variables = baseQuery.variables;\n        var operationName = utils_1.getOperationFieldName(query);\n        var _f = operationName, baseResult = cache.readQuery({ query: query, variables: variables })[_f];\n        if (!Array.isArray(baseResult)) {\n            throw new Error('Result of baseQuery is not an array');\n        }\n        var result = deltaRecordsProcessor(updateLogger, deltaOperationName, deltaRecords, baseResult, typename, idField);\n        if (result !== baseResult) {\n            cache.writeQuery({ query: query, data: (_a = {}, _a[operationName] = result, _a) });\n        }\n    }\n    writeCacheUpdates(updateLogger, cache, deltaRecords, cacheUpdates);\n};\n//#endregion\nexports.offlineEffectConfig = {\n    enqueueAction: actions.ENQUEUE,\n    effect: effect,\n    discard: discard,\n    reducer: reducer,\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}