{"ast":null,"code":"\"use strict\";\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n/*!\n * Copyright 2017-2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n * SPDX-License-Identifier: Apache-2.0\n */\n\nvar apollo_link_1 = require(\"apollo-link\");\n\nvar utils_1 = require(\"./utils\");\n\nvar aws_appsync_auth_link_1 = require(\"aws-appsync-auth-link\");\n\nvar graphql_1 = require(\"graphql\");\n\nvar url = require(\"url\");\n\nvar uuid_1 = require(\"uuid\");\n\nvar types_1 = require(\"./types\");\n\nvar retry_1 = require(\"./utils/retry\");\n\nvar logger = utils_1.rootLogger.extend(\"subscriptions\");\nexports.CONTROL_EVENTS_KEY = \"@@controlEvents\";\nvar NON_RETRYABLE_CODES = [400, 401, 403];\nvar SERVICE = \"appsync\";\nvar APPSYNC_REALTIME_HEADERS = {\n  accept: \"application/json, text/javascript\",\n  \"content-encoding\": \"amz-1.0\",\n  \"content-type\": \"application/json; charset=UTF-8\"\n};\n/**\n * Time in milliseconds to wait for GQL_CONNECTION_INIT message\n */\n\nvar CONNECTION_INIT_TIMEOUT = 15000;\n/**\n * Time in milliseconds to wait for GQL_START_ACK message\n */\n\nvar START_ACK_TIMEOUT = 15000;\n/**\n * Default Time in milliseconds to wait for GQL_CONNECTION_KEEP_ALIVE message\n */\n\nvar DEFAULT_KEEP_ALIVE_TIMEOUT = 5 * 60 * 1000;\n\nvar AppSyncRealTimeSubscriptionHandshakeLink =\n/** @class */\nfunction (_super) {\n  __extends(AppSyncRealTimeSubscriptionHandshakeLink, _super);\n\n  function AppSyncRealTimeSubscriptionHandshakeLink(_a) {\n    var theUrl = _a.url,\n        theRegion = _a.region,\n        theAuth = _a.auth;\n\n    var _this = _super.call(this) || this;\n\n    _this.socketStatus = types_1.SOCKET_STATUS.CLOSED;\n    _this.keepAliveTimeout = DEFAULT_KEEP_ALIVE_TIMEOUT;\n    _this.subscriptionObserverMap = new Map();\n    _this.promiseArray = [];\n    _this.url = theUrl;\n    _this.region = theRegion;\n    _this.auth = theAuth;\n    return _this;\n  }\n\n  AppSyncRealTimeSubscriptionHandshakeLink.prototype.request = function (operation) {\n    var _a;\n\n    var _this = this;\n\n    var query = operation.query,\n        variables = operation.variables;\n\n    var _b = operation.getContext(),\n        _c = _b.controlMessages,\n        _d = exports.CONTROL_EVENTS_KEY,\n        controlEvents = (_c === void 0 ? (_a = {}, _a[exports.CONTROL_EVENTS_KEY] = undefined, _a) : _c)[_d],\n        headers = _b.headers;\n\n    return new apollo_link_1.Observable(function (observer) {\n      if (!_this.url) {\n        observer.error({\n          errors: [__assign({}, new graphql_1.GraphQLError(\"Subscribe only available for AWS AppSync endpoint\"))]\n        });\n        observer.complete();\n      } else {\n        var subscriptionId_1 = uuid_1.v4();\n        var token = _this.auth.type === aws_appsync_auth_link_1.AUTH_TYPE.AMAZON_COGNITO_USER_POOLS || _this.auth.type === aws_appsync_auth_link_1.AUTH_TYPE.OPENID_CONNECT ? _this.auth.jwtToken : null;\n        token = _this.auth.type === aws_appsync_auth_link_1.AUTH_TYPE.AWS_LAMBDA ? _this.auth.token : token;\n        var options = {\n          appSyncGraphqlEndpoint: _this.url,\n          authenticationType: _this.auth.type,\n          query: graphql_1.print(query),\n          region: _this.region,\n          graphql_headers: function () {\n            return headers;\n          },\n          variables: variables,\n          apiKey: _this.auth.type === aws_appsync_auth_link_1.AUTH_TYPE.API_KEY ? _this.auth.apiKey : \"\",\n          credentials: _this.auth.type === aws_appsync_auth_link_1.AUTH_TYPE.AWS_IAM ? _this.auth.credentials : null,\n          token: token\n        };\n\n        _this._startSubscriptionWithAWSAppSyncRealTime({\n          options: options,\n          observer: observer,\n          subscriptionId: subscriptionId_1\n        });\n\n        return function () {\n          return __awaiter(_this, void 0, void 0, function () {\n            var subscriptionState;\n            return __generator(this, function (_a) {\n              // Cleanup after unsubscribing or observer.complete was called after _startSubscriptionWithAWSAppSyncRealTime\n              try {\n                this._verifySubscriptionAlreadyStarted(subscriptionId_1);\n\n                subscriptionState = this.subscriptionObserverMap.get(subscriptionId_1).subscriptionState;\n\n                if (subscriptionState === types_1.SUBSCRIPTION_STATUS.CONNECTED) {\n                  this._sendUnsubscriptionMessage(subscriptionId_1);\n                } else {\n                  throw new Error(\"Subscription has failed, starting to remove subscription.\");\n                }\n              } catch (err) {\n                this._removeSubscriptionObserver(subscriptionId_1);\n\n                return [2\n                /*return*/\n                ];\n              }\n\n              return [2\n              /*return*/\n              ];\n            });\n          });\n        };\n      }\n    }).filter(function (data) {\n      var _a = data.extensions,\n          _b = (_a === void 0 ? {} : _a).controlMsgType,\n          controlMsgType = _b === void 0 ? undefined : _b;\n      var isControlMsg = typeof controlMsgType !== \"undefined\";\n      return controlEvents === true || !isControlMsg;\n    });\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink.prototype._verifySubscriptionAlreadyStarted = function (subscriptionId) {\n    return __awaiter(this, void 0, void 0, function () {\n      var subscriptionState;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        subscriptionState = this.subscriptionObserverMap.get(subscriptionId).subscriptionState; // This in case unsubscribe is invoked before sending start subscription message\n\n        if (subscriptionState === types_1.SUBSCRIPTION_STATUS.PENDING) {\n          return [2\n          /*return*/\n          , new Promise(function (res, rej) {\n            var _a = _this.subscriptionObserverMap.get(subscriptionId),\n                observer = _a.observer,\n                subscriptionState = _a.subscriptionState,\n                variables = _a.variables,\n                query = _a.query;\n\n            _this.subscriptionObserverMap.set(subscriptionId, {\n              observer: observer,\n              subscriptionState: subscriptionState,\n              variables: variables,\n              query: query,\n              subscriptionReadyCallback: res,\n              subscriptionFailedCallback: rej\n            });\n          })];\n        }\n\n        return [2\n        /*return*/\n        ];\n      });\n    });\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink.prototype._sendUnsubscriptionMessage = function (subscriptionId) {\n    try {\n      if (this.awsRealTimeSocket && this.awsRealTimeSocket.readyState === WebSocket.OPEN && this.socketStatus === types_1.SOCKET_STATUS.READY) {\n        // Preparing unsubscribe message to stop receiving messages for that subscription\n        var unsubscribeMessage = {\n          id: subscriptionId,\n          type: types_1.MESSAGE_TYPES.GQL_STOP\n        };\n        var stringToAWSRealTime = JSON.stringify(unsubscribeMessage);\n        this.awsRealTimeSocket.send(stringToAWSRealTime);\n\n        this._removeSubscriptionObserver(subscriptionId);\n      }\n    } catch (err) {\n      // If GQL_STOP is not sent because of disconnection issue, then there is nothing the client can do\n      logger({\n        err: err\n      });\n    }\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink.prototype._removeSubscriptionObserver = function (subscriptionId) {\n    this.subscriptionObserverMap.delete(subscriptionId); // Verifying for 1000ms after removing subscription in case there are new subscriptions on mount / unmount\n\n    setTimeout(this._closeSocketIfRequired.bind(this), 1000);\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink.prototype._closeSocketIfRequired = function () {\n    if (this.subscriptionObserverMap.size > 0) {\n      // There are active subscriptions on the WebSocket\n      return;\n    }\n\n    if (!this.awsRealTimeSocket) {\n      this.socketStatus = types_1.SOCKET_STATUS.CLOSED;\n      return;\n    }\n\n    if (this.awsRealTimeSocket.bufferedAmount > 0) {\n      // There is still data on the WebSocket\n      setTimeout(this._closeSocketIfRequired.bind(this), 1000);\n    } else {\n      logger(\"closing WebSocket...\");\n      clearTimeout(this.keepAliveTimeoutId);\n      var tempSocket = this.awsRealTimeSocket;\n      tempSocket.close(1000);\n      this.awsRealTimeSocket = null;\n      this.socketStatus = types_1.SOCKET_STATUS.CLOSED;\n    }\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink.prototype._startSubscriptionWithAWSAppSyncRealTime = function (_a) {\n    var options = _a.options,\n        observer = _a.observer,\n        subscriptionId = _a.subscriptionId;\n    return __awaiter(this, void 0, void 0, function () {\n      var appSyncGraphqlEndpoint, authenticationType, query, variables, apiKey, region, _b, graphql_headers, credentials, token, subscriptionState, data, dataString, headerObj, _c, subscriptionMessage, stringToAWSRealTime, err_1, _d, message, subscriptionFailedCallback_1, _e, subscriptionFailedCallback, subscriptionReadyCallback;\n\n      var _f;\n\n      var _this = this;\n\n      return __generator(this, function (_g) {\n        switch (_g.label) {\n          case 0:\n            appSyncGraphqlEndpoint = options.appSyncGraphqlEndpoint, authenticationType = options.authenticationType, query = options.query, variables = options.variables, apiKey = options.apiKey, region = options.region, _b = options.graphql_headers, graphql_headers = _b === void 0 ? function () {\n              return {};\n            } : _b, credentials = options.credentials, token = options.token;\n            subscriptionState = types_1.SUBSCRIPTION_STATUS.PENDING;\n            data = {\n              query: query,\n              variables: variables\n            }; // Having a subscription id map will make it simple to forward messages received\n\n            this.subscriptionObserverMap.set(subscriptionId, {\n              observer: observer,\n              query: query,\n              variables: variables,\n              subscriptionState: subscriptionState,\n              startAckTimeoutId: null\n            });\n            dataString = JSON.stringify(data);\n            _c = [{}];\n            return [4\n            /*yield*/\n            , this._awsRealTimeHeaderBasedAuth({\n              apiKey: apiKey,\n              appSyncGraphqlEndpoint: appSyncGraphqlEndpoint,\n              authenticationType: authenticationType,\n              payload: dataString,\n              canonicalUri: \"\",\n              region: region,\n              credentials: credentials,\n              token: token,\n              graphql_headers: graphql_headers\n            })];\n\n          case 1:\n            headerObj = __assign.apply(void 0, [__assign.apply(void 0, _c.concat([_g.sent()])), (_f = {}, _f[aws_appsync_auth_link_1.USER_AGENT_HEADER] = aws_appsync_auth_link_1.USER_AGENT, _f)]);\n            subscriptionMessage = {\n              id: subscriptionId,\n              payload: {\n                data: dataString,\n                extensions: {\n                  authorization: __assign({}, headerObj)\n                }\n              },\n              type: types_1.MESSAGE_TYPES.GQL_START\n            };\n            stringToAWSRealTime = JSON.stringify(subscriptionMessage);\n            _g.label = 2;\n\n          case 2:\n            _g.trys.push([2, 4,, 5]);\n\n            return [4\n            /*yield*/\n            , this._initializeWebSocketConnection({\n              apiKey: apiKey,\n              appSyncGraphqlEndpoint: appSyncGraphqlEndpoint,\n              authenticationType: authenticationType,\n              region: region,\n              credentials: credentials,\n              token: token\n            })];\n\n          case 3:\n            _g.sent();\n\n            return [3\n            /*break*/\n            , 5];\n\n          case 4:\n            err_1 = _g.sent();\n            _d = err_1.message, message = _d === void 0 ? \"\" : _d;\n            observer.error({\n              errors: [__assign({}, new graphql_1.GraphQLError(\"Connection failed: \" + message))]\n            });\n            observer.complete();\n            subscriptionFailedCallback_1 = (this.subscriptionObserverMap.get(subscriptionId) || {}).subscriptionFailedCallback; // Notify concurrent unsubscription\n\n            if (typeof subscriptionFailedCallback_1 === \"function\") {\n              subscriptionFailedCallback_1();\n            }\n\n            return [2\n            /*return*/\n            ];\n\n          case 5:\n            _e = this.subscriptionObserverMap.get(subscriptionId), subscriptionFailedCallback = _e.subscriptionFailedCallback, subscriptionReadyCallback = _e.subscriptionReadyCallback; // This must be done before sending the message in order to be listening immediately\n\n            this.subscriptionObserverMap.set(subscriptionId, {\n              observer: observer,\n              subscriptionState: subscriptionState,\n              variables: variables,\n              query: query,\n              subscriptionReadyCallback: subscriptionReadyCallback,\n              subscriptionFailedCallback: subscriptionFailedCallback,\n              startAckTimeoutId: setTimeout(function () {\n                _this._timeoutStartSubscriptionAck.call(_this, subscriptionId);\n              }, START_ACK_TIMEOUT)\n            });\n\n            if (this.awsRealTimeSocket) {\n              this.awsRealTimeSocket.send(stringToAWSRealTime);\n            }\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink.prototype._initializeWebSocketConnection = function (_a) {\n    var _this = this;\n\n    var appSyncGraphqlEndpoint = _a.appSyncGraphqlEndpoint,\n        authenticationType = _a.authenticationType,\n        apiKey = _a.apiKey,\n        region = _a.region,\n        credentials = _a.credentials,\n        token = _a.token;\n\n    if (this.socketStatus === types_1.SOCKET_STATUS.READY) {\n      return;\n    }\n\n    return new Promise(function (res, rej) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var discoverableEndpoint, payloadString, headerString, _a, _b, headerQs, payloadQs, awsRealTimeUrl, err_2;\n\n        return __generator(this, function (_c) {\n          switch (_c.label) {\n            case 0:\n              this.promiseArray.push({\n                res: res,\n                rej: rej\n              });\n              if (!(this.socketStatus === types_1.SOCKET_STATUS.CLOSED)) return [3\n              /*break*/\n              , 5];\n              _c.label = 1;\n\n            case 1:\n              _c.trys.push([1, 4,, 5]);\n\n              this.socketStatus = types_1.SOCKET_STATUS.CONNECTING;\n              discoverableEndpoint = AppSyncRealTimeSubscriptionHandshakeLink._discoverAppSyncRealTimeEndpoint(this.url);\n              payloadString = \"{}\";\n              _b = (_a = JSON).stringify;\n              return [4\n              /*yield*/\n              , this._awsRealTimeHeaderBasedAuth({\n                authenticationType: authenticationType,\n                payload: payloadString,\n                canonicalUri: \"/connect\",\n                apiKey: apiKey,\n                appSyncGraphqlEndpoint: appSyncGraphqlEndpoint,\n                region: region,\n                credentials: credentials,\n                token: token,\n                graphql_headers: function () {}\n              })];\n\n            case 2:\n              headerString = _b.apply(_a, [_c.sent()]);\n              headerQs = Buffer.from(headerString).toString(\"base64\");\n              payloadQs = Buffer.from(payloadString).toString(\"base64\");\n              awsRealTimeUrl = discoverableEndpoint + \"?header=\" + headerQs + \"&payload=\" + payloadQs;\n              return [4\n              /*yield*/\n              , this._initializeRetryableHandshake({\n                awsRealTimeUrl: awsRealTimeUrl\n              })];\n\n            case 3:\n              _c.sent();\n\n              this.promiseArray.forEach(function (_a) {\n                var res = _a.res;\n                logger(\"Notifying connection successful\");\n                res();\n              });\n              this.socketStatus = types_1.SOCKET_STATUS.READY;\n              this.promiseArray = [];\n              return [3\n              /*break*/\n              , 5];\n\n            case 4:\n              err_2 = _c.sent();\n              this.promiseArray.forEach(function (_a) {\n                var rej = _a.rej;\n                return rej(err_2);\n              });\n              this.promiseArray = [];\n\n              if (this.awsRealTimeSocket && this.awsRealTimeSocket.readyState === WebSocket.OPEN) {\n                this.awsRealTimeSocket.close(3001);\n              }\n\n              this.awsRealTimeSocket = null;\n              this.socketStatus = types_1.SOCKET_STATUS.CLOSED;\n              return [3\n              /*break*/\n              , 5];\n\n            case 5:\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    });\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink.prototype._awsRealTimeHeaderBasedAuth = function (_a) {\n    var authenticationType = _a.authenticationType,\n        payload = _a.payload,\n        canonicalUri = _a.canonicalUri,\n        appSyncGraphqlEndpoint = _a.appSyncGraphqlEndpoint,\n        apiKey = _a.apiKey,\n        region = _a.region,\n        credentials = _a.credentials,\n        token = _a.token,\n        graphql_headers = _a.graphql_headers;\n    return __awaiter(this, void 0, void 0, function () {\n      var headerHandler, handler, host, result;\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            headerHandler = {\n              API_KEY: this._awsRealTimeApiKeyHeader.bind(this),\n              AWS_IAM: this._awsRealTimeIAMHeader.bind(this),\n              OPENID_CONNECT: this._awsRealTimeAuthorizationHeader.bind(this),\n              AMAZON_COGNITO_USER_POOLS: this._awsRealTimeAuthorizationHeader.bind(this),\n              AWS_LAMBDA: this._awsRealTimeAuthorizationHeader.bind(this)\n            };\n            handler = headerHandler[authenticationType];\n\n            if (typeof handler !== \"function\") {\n              logger(\"Authentication type \" + authenticationType + \" not supported\");\n              return [2\n              /*return*/\n              , {}];\n            }\n\n            host = url.parse(appSyncGraphqlEndpoint).host;\n            return [4\n            /*yield*/\n            , handler({\n              payload: payload,\n              canonicalUri: canonicalUri,\n              appSyncGraphqlEndpoint: appSyncGraphqlEndpoint,\n              apiKey: apiKey,\n              region: region,\n              host: host,\n              credentials: credentials,\n              token: token,\n              graphql_headers: graphql_headers\n            })];\n\n          case 1:\n            result = _b.sent();\n            return [2\n            /*return*/\n            , result];\n        }\n      });\n    });\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink.prototype._awsRealTimeAuthorizationHeader = function (_a) {\n    var host = _a.host,\n        token = _a.token,\n        graphql_headers = _a.graphql_headers;\n    return __awaiter(this, void 0, void 0, function () {\n      var _b, _c, _d;\n\n      return __generator(this, function (_e) {\n        switch (_e.label) {\n          case 0:\n            _b = {};\n            if (!(typeof token === \"function\")) return [3\n            /*break*/\n            , 2];\n            return [4\n            /*yield*/\n            , token.call(undefined)];\n\n          case 1:\n            _c = _e.sent();\n            return [3\n            /*break*/\n            , 4];\n\n          case 2:\n            return [4\n            /*yield*/\n            , token];\n\n          case 3:\n            _c = _e.sent();\n            _e.label = 4;\n\n          case 4:\n            _d = [(_b.Authorization = _c, _b.host = host, _b)];\n            return [4\n            /*yield*/\n            , graphql_headers()];\n\n          case 5:\n            return [2\n            /*return*/\n            , __assign.apply(void 0, _d.concat([_e.sent()]))];\n        }\n      });\n    });\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink.prototype._awsRealTimeApiKeyHeader = function (_a) {\n    var apiKey = _a.apiKey,\n        host = _a.host,\n        graphql_headers = _a.graphql_headers;\n    return __awaiter(this, void 0, void 0, function () {\n      var dt, dtStr, _b;\n\n      return __generator(this, function (_c) {\n        switch (_c.label) {\n          case 0:\n            dt = new Date();\n            dtStr = dt.toISOString().replace(/[:\\-]|\\.\\d{3}/g, \"\");\n            _b = [{\n              host: host,\n              \"x-amz-date\": dtStr,\n              \"x-api-key\": apiKey\n            }];\n            return [4\n            /*yield*/\n            , graphql_headers()];\n\n          case 1:\n            return [2\n            /*return*/\n            , __assign.apply(void 0, _b.concat([_c.sent()]))];\n        }\n      });\n    });\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink.prototype._awsRealTimeIAMHeader = function (_a) {\n    var payload = _a.payload,\n        canonicalUri = _a.canonicalUri,\n        appSyncGraphqlEndpoint = _a.appSyncGraphqlEndpoint,\n        region = _a.region,\n        credentials = _a.credentials;\n    return __awaiter(this, void 0, void 0, function () {\n      var endpointInfo, creds, _b, accessKeyId, secretAccessKey, sessionToken, formattedCredentials, request, signed_params;\n\n      return __generator(this, function (_c) {\n        switch (_c.label) {\n          case 0:\n            endpointInfo = {\n              region: region,\n              service: SERVICE\n            };\n            creds = typeof credentials === \"function\" ? credentials.call() : credentials || {};\n            if (!(creds && typeof creds.getPromise === \"function\")) return [3\n            /*break*/\n            , 2];\n            return [4\n            /*yield*/\n            , creds.getPromise()];\n\n          case 1:\n            _c.sent();\n\n            _c.label = 2;\n\n          case 2:\n            if (!creds) {\n              throw new Error(\"No credentials\");\n            }\n\n            return [4\n            /*yield*/\n            , creds];\n\n          case 3:\n            _b = _c.sent(), accessKeyId = _b.accessKeyId, secretAccessKey = _b.secretAccessKey, sessionToken = _b.sessionToken;\n            formattedCredentials = {\n              access_key: accessKeyId,\n              secret_key: secretAccessKey,\n              session_token: sessionToken\n            };\n            request = {\n              url: \"\" + appSyncGraphqlEndpoint + canonicalUri,\n              body: payload,\n              method: \"POST\",\n              headers: __assign({}, APPSYNC_REALTIME_HEADERS)\n            };\n            signed_params = aws_appsync_auth_link_1.Signer.sign(request, formattedCredentials, endpointInfo);\n            return [2\n            /*return*/\n            , signed_params.headers];\n        }\n      });\n    });\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink.prototype._initializeRetryableHandshake = function (_a) {\n    var awsRealTimeUrl = _a.awsRealTimeUrl;\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            logger(\"Initializaling retryable Handshake\");\n            return [4\n            /*yield*/\n            , retry_1.jitteredExponentialRetry(this._initializeHandshake.bind(this), [{\n              awsRealTimeUrl: awsRealTimeUrl\n            }])];\n\n          case 1:\n            _b.sent();\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink.prototype._initializeHandshake = function (_a) {\n    var awsRealTimeUrl = _a.awsRealTimeUrl;\n    return __awaiter(this, void 0, void 0, function () {\n      var err_3, errorType, errorCode;\n\n      var _this = this;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            logger(\"Initializing handshake \" + awsRealTimeUrl);\n            _b.label = 1;\n\n          case 1:\n            _b.trys.push([1, 4,, 5]);\n\n            return [4\n            /*yield*/\n            , function () {\n              return new Promise(function (res, rej) {\n                var newSocket = AppSyncRealTimeSubscriptionHandshakeLink.createWebSocket(awsRealTimeUrl, \"graphql-ws\");\n\n                newSocket.onerror = function () {\n                  logger(\"WebSocket connection error\");\n                };\n\n                newSocket.onclose = function () {\n                  rej(new Error(\"Connection handshake error\"));\n                };\n\n                newSocket.onopen = function () {\n                  _this.awsRealTimeSocket = newSocket;\n                  return res();\n                };\n              });\n            }()];\n\n          case 2:\n            _b.sent(); // Step 2: wait for ack from AWS AppSyncReaTime after sending init\n\n\n            return [4\n            /*yield*/\n            , function () {\n              return new Promise(function (res, rej) {\n                var ackOk = false;\n\n                _this.awsRealTimeSocket.onerror = function (error) {\n                  logger(\"WebSocket closed \" + JSON.stringify(error));\n                };\n\n                _this.awsRealTimeSocket.onclose = function (event) {\n                  logger(\"WebSocket closed \" + event.reason);\n                  rej(new Error(JSON.stringify(event)));\n                };\n\n                _this.awsRealTimeSocket.onmessage = function (message) {\n                  logger(\"subscription message from AWS AppSyncRealTime: \" + message.data + \" \");\n                  var data = JSON.parse(message.data);\n                  var type = data.type,\n                      _a = data.payload,\n                      _b = (_a === void 0 ? {} : _a).connectionTimeoutMs,\n                      connectionTimeoutMs = _b === void 0 ? DEFAULT_KEEP_ALIVE_TIMEOUT : _b;\n\n                  if (type === types_1.MESSAGE_TYPES.GQL_CONNECTION_ACK) {\n                    ackOk = true;\n                    _this.keepAliveTimeout = connectionTimeoutMs;\n                    _this.awsRealTimeSocket.onmessage = _this._handleIncomingSubscriptionMessage.bind(_this);\n\n                    _this.awsRealTimeSocket.onerror = function (err) {\n                      logger(err);\n\n                      _this._errorDisconnect(types_1.CONTROL_MSG.CONNECTION_CLOSED);\n                    };\n\n                    _this.awsRealTimeSocket.onclose = function (event) {\n                      logger(\"WebSocket closed \" + event.reason);\n\n                      _this._errorDisconnect(types_1.CONTROL_MSG.CONNECTION_CLOSED);\n                    };\n\n                    res(\"Cool, connected to AWS AppSyncRealTime\");\n                    return;\n                  }\n\n                  if (type === types_1.MESSAGE_TYPES.GQL_CONNECTION_ERROR) {\n                    var _c = data.payload,\n                        _d = (_c === void 0 ? {} : _c).errors,\n                        _e = (_d === void 0 ? [] : _d)[0],\n                        _f = _e === void 0 ? {} : _e,\n                        _g = _f.errorType,\n                        errorType = _g === void 0 ? \"\" : _g,\n                        _h = _f.errorCode,\n                        errorCode = _h === void 0 ? 0 : _h;\n\n                    rej({\n                      errorType: errorType,\n                      errorCode: errorCode\n                    });\n                  }\n                };\n\n                var gqlInit = {\n                  type: types_1.MESSAGE_TYPES.GQL_CONNECTION_INIT\n                };\n\n                _this.awsRealTimeSocket.send(JSON.stringify(gqlInit));\n\n                function checkAckOk() {\n                  if (!ackOk) {\n                    rej(new Error(\"Connection timeout: ack from AWSRealTime was not received on \" + CONNECTION_INIT_TIMEOUT + \" ms\"));\n                  }\n                }\n\n                setTimeout(checkAckOk.bind(_this), CONNECTION_INIT_TIMEOUT);\n              });\n            }()];\n\n          case 3:\n            // Step 2: wait for ack from AWS AppSyncReaTime after sending init\n            _b.sent();\n\n            return [3\n            /*break*/\n            , 5];\n\n          case 4:\n            err_3 = _b.sent();\n            errorType = err_3.errorType, errorCode = err_3.errorCode;\n\n            if (NON_RETRYABLE_CODES.indexOf(errorCode) >= 0) {\n              throw new retry_1.NonRetryableError(errorType);\n            } else if (errorType) {\n              throw new Error(errorType);\n            } else {\n              throw err_3;\n            }\n\n            return [3\n            /*break*/\n            , 5];\n\n          case 5:\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink.prototype._handleIncomingSubscriptionMessage = function (message) {\n    logger(\"subscription message from AWS AppSync RealTime: \" + message.data);\n\n    var _a = JSON.parse(message.data),\n        _b = _a.id,\n        id = _b === void 0 ? \"\" : _b,\n        payload = _a.payload,\n        type = _a.type;\n\n    var _c = this.subscriptionObserverMap.get(id) || {},\n        _d = _c.observer,\n        observer = _d === void 0 ? null : _d,\n        _e = _c.query,\n        query = _e === void 0 ? \"\" : _e,\n        _f = _c.variables,\n        variables = _f === void 0 ? {} : _f,\n        _g = _c.startAckTimeoutId,\n        startAckTimeoutId = _g === void 0 ? 0 : _g,\n        _h = _c.subscriptionReadyCallback,\n        subscriptionReadyCallback = _h === void 0 ? null : _h,\n        _j = _c.subscriptionFailedCallback,\n        subscriptionFailedCallback = _j === void 0 ? null : _j;\n\n    logger({\n      id: id,\n      observer: observer,\n      query: query,\n      variables: variables\n    });\n\n    if (type === types_1.MESSAGE_TYPES.GQL_DATA && payload && payload.data) {\n      if (observer) {\n        observer.next(payload);\n      } else {\n        logger(\"observer not found for id: \" + id);\n      }\n\n      return;\n    }\n\n    if (type === types_1.MESSAGE_TYPES.GQL_START_ACK) {\n      logger(\"subscription ready for \" + JSON.stringify({\n        query: query,\n        variables: variables\n      }));\n\n      if (typeof subscriptionReadyCallback === \"function\") {\n        subscriptionReadyCallback();\n      }\n\n      clearTimeout(startAckTimeoutId);\n\n      if (observer) {\n        observer.next({\n          data: payload,\n          extensions: {\n            controlMsgType: \"CONNECTED\"\n          }\n        });\n      } else {\n        logger(\"observer not found for id: \" + id);\n      }\n\n      var subscriptionState = types_1.SUBSCRIPTION_STATUS.CONNECTED;\n      this.subscriptionObserverMap.set(id, {\n        observer: observer,\n        query: query,\n        variables: variables,\n        startAckTimeoutId: null,\n        subscriptionState: subscriptionState,\n        subscriptionReadyCallback: subscriptionReadyCallback,\n        subscriptionFailedCallback: subscriptionFailedCallback\n      });\n      return;\n    }\n\n    if (type === types_1.MESSAGE_TYPES.GQL_CONNECTION_KEEP_ALIVE) {\n      clearTimeout(this.keepAliveTimeoutId);\n      this.keepAliveTimeoutId = setTimeout(this._errorDisconnect.bind(this, types_1.CONTROL_MSG.TIMEOUT_DISCONNECT), this.keepAliveTimeout);\n      return;\n    }\n\n    if (type === types_1.MESSAGE_TYPES.GQL_ERROR) {\n      var subscriptionState = types_1.SUBSCRIPTION_STATUS.FAILED;\n      this.subscriptionObserverMap.set(id, {\n        observer: observer,\n        query: query,\n        variables: variables,\n        startAckTimeoutId: startAckTimeoutId,\n        subscriptionReadyCallback: subscriptionReadyCallback,\n        subscriptionFailedCallback: subscriptionFailedCallback,\n        subscriptionState: subscriptionState\n      });\n      observer.error({\n        errors: [__assign({}, new graphql_1.GraphQLError(\"Connection failed: \" + JSON.stringify(payload)))]\n      });\n      clearTimeout(startAckTimeoutId);\n      observer.complete();\n\n      if (typeof subscriptionFailedCallback === \"function\") {\n        subscriptionFailedCallback();\n      }\n    }\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink.prototype._errorDisconnect = function (msg) {\n    logger(\"Disconnect error: \" + msg);\n    this.subscriptionObserverMap.forEach(function (_a) {\n      var observer = _a.observer;\n\n      if (observer && !observer.closed) {\n        observer.error({\n          errors: [__assign({}, new graphql_1.GraphQLError(msg))]\n        });\n      }\n    });\n    this.subscriptionObserverMap.clear();\n\n    if (this.awsRealTimeSocket) {\n      this.awsRealTimeSocket.close();\n    }\n\n    this.socketStatus = types_1.SOCKET_STATUS.CLOSED;\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink.prototype._timeoutStartSubscriptionAck = function (subscriptionId) {\n    var _a = this.subscriptionObserverMap.get(subscriptionId) || {},\n        observer = _a.observer,\n        query = _a.query,\n        variables = _a.variables;\n\n    if (!observer) {\n      return;\n    }\n\n    this.subscriptionObserverMap.set(subscriptionId, {\n      observer: observer,\n      query: query,\n      variables: variables,\n      subscriptionState: types_1.SUBSCRIPTION_STATUS.FAILED\n    });\n\n    if (observer && !observer.closed) {\n      observer.error({\n        errors: [__assign({}, new graphql_1.GraphQLError(\"Subscription timeout \" + JSON.stringify({\n          query: query,\n          variables: variables\n        })))]\n      }); // Cleanup will be automatically executed\n\n      observer.complete();\n    }\n\n    logger(\"timeoutStartSubscription\", JSON.stringify({\n      query: query,\n      variables: variables\n    }));\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink.createWebSocket = function (awsRealTimeUrl, protocol) {\n    return new WebSocket(awsRealTimeUrl, protocol);\n  };\n\n  AppSyncRealTimeSubscriptionHandshakeLink._discoverAppSyncRealTimeEndpoint = function (url) {\n    return url.replace(\"https://\", \"wss://\").replace(\"http://\", \"ws://\").replace(\"appsync-api\", \"appsync-realtime-api\").replace(\"gogi-beta\", \"grt-beta\");\n  };\n\n  return AppSyncRealTimeSubscriptionHandshakeLink;\n}(apollo_link_1.ApolloLink);\n\nexports.AppSyncRealTimeSubscriptionHandshakeLink = AppSyncRealTimeSubscriptionHandshakeLink;","map":{"version":3,"names":["__extends","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__","constructor","prototype","create","__assign","assign","t","s","i","n","arguments","length","call","apply","__awaiter","thisArg","_arguments","P","generator","adopt","value","resolve","Promise","reject","fulfilled","step","next","e","rejected","result","done","then","__generator","body","_","label","sent","trys","ops","f","y","g","verb","Symbol","iterator","v","op","TypeError","pop","push","defineProperty","exports","apollo_link_1","require","utils_1","aws_appsync_auth_link_1","graphql_1","url","uuid_1","types_1","retry_1","logger","rootLogger","extend","CONTROL_EVENTS_KEY","NON_RETRYABLE_CODES","SERVICE","APPSYNC_REALTIME_HEADERS","accept","CONNECTION_INIT_TIMEOUT","START_ACK_TIMEOUT","DEFAULT_KEEP_ALIVE_TIMEOUT","AppSyncRealTimeSubscriptionHandshakeLink","_super","_a","theUrl","theRegion","region","theAuth","auth","_this","socketStatus","SOCKET_STATUS","CLOSED","keepAliveTimeout","subscriptionObserverMap","Map","promiseArray","request","operation","query","variables","_b","getContext","_c","controlMessages","_d","controlEvents","undefined","headers","Observable","observer","error","errors","GraphQLError","complete","subscriptionId_1","v4","token","type","AUTH_TYPE","AMAZON_COGNITO_USER_POOLS","OPENID_CONNECT","jwtToken","AWS_LAMBDA","options","appSyncGraphqlEndpoint","authenticationType","print","graphql_headers","apiKey","API_KEY","credentials","AWS_IAM","_startSubscriptionWithAWSAppSyncRealTime","subscriptionId","subscriptionState","_verifySubscriptionAlreadyStarted","get","SUBSCRIPTION_STATUS","CONNECTED","_sendUnsubscriptionMessage","Error","err","_removeSubscriptionObserver","filter","data","extensions","controlMsgType","isControlMsg","PENDING","res","rej","set","subscriptionReadyCallback","subscriptionFailedCallback","awsRealTimeSocket","readyState","WebSocket","OPEN","READY","unsubscribeMessage","id","MESSAGE_TYPES","GQL_STOP","stringToAWSRealTime","JSON","stringify","send","delete","setTimeout","_closeSocketIfRequired","bind","size","bufferedAmount","clearTimeout","keepAliveTimeoutId","tempSocket","close","dataString","headerObj","subscriptionMessage","err_1","message","subscriptionFailedCallback_1","_e","_f","_g","startAckTimeoutId","_awsRealTimeHeaderBasedAuth","payload","canonicalUri","concat","USER_AGENT_HEADER","USER_AGENT","authorization","GQL_START","_initializeWebSocketConnection","_timeoutStartSubscriptionAck","discoverableEndpoint","payloadString","headerString","headerQs","payloadQs","awsRealTimeUrl","err_2","CONNECTING","_discoverAppSyncRealTimeEndpoint","Buffer","from","toString","_initializeRetryableHandshake","forEach","headerHandler","handler","host","_awsRealTimeApiKeyHeader","_awsRealTimeIAMHeader","_awsRealTimeAuthorizationHeader","parse","Authorization","dt","dtStr","Date","toISOString","replace","endpointInfo","creds","accessKeyId","secretAccessKey","sessionToken","formattedCredentials","signed_params","service","getPromise","access_key","secret_key","session_token","method","Signer","sign","jitteredExponentialRetry","_initializeHandshake","err_3","errorType","errorCode","newSocket","createWebSocket","onerror","onclose","onopen","ackOk","event","reason","onmessage","connectionTimeoutMs","GQL_CONNECTION_ACK","_handleIncomingSubscriptionMessage","_errorDisconnect","CONTROL_MSG","CONNECTION_CLOSED","GQL_CONNECTION_ERROR","_h","gqlInit","GQL_CONNECTION_INIT","checkAckOk","indexOf","NonRetryableError","_j","GQL_DATA","GQL_START_ACK","GQL_CONNECTION_KEEP_ALIVE","TIMEOUT_DISCONNECT","GQL_ERROR","FAILED","msg","closed","clear","protocol","ApolloLink"],"sources":["/Users/roaldmaravillas/ro/github/scaffold-appsync-events/node_modules/aws-appsync-subscription-link/lib/realtime-subscription-handshake-link.js"],"sourcesContent":["\"use strict\";\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar __assign = (this && this.__assign) || function () {\n    __assign = Object.assign || function(t) {\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\n            s = arguments[i];\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n                t[p] = s[p];\n        }\n        return t;\n    };\n    return __assign.apply(this, arguments);\n};\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\n/*!\n * Copyright 2017-2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n * SPDX-License-Identifier: Apache-2.0\n */\nvar apollo_link_1 = require(\"apollo-link\");\nvar utils_1 = require(\"./utils\");\nvar aws_appsync_auth_link_1 = require(\"aws-appsync-auth-link\");\nvar graphql_1 = require(\"graphql\");\nvar url = require(\"url\");\nvar uuid_1 = require(\"uuid\");\nvar types_1 = require(\"./types\");\nvar retry_1 = require(\"./utils/retry\");\nvar logger = utils_1.rootLogger.extend(\"subscriptions\");\nexports.CONTROL_EVENTS_KEY = \"@@controlEvents\";\nvar NON_RETRYABLE_CODES = [400, 401, 403];\nvar SERVICE = \"appsync\";\nvar APPSYNC_REALTIME_HEADERS = {\n    accept: \"application/json, text/javascript\",\n    \"content-encoding\": \"amz-1.0\",\n    \"content-type\": \"application/json; charset=UTF-8\",\n};\n/**\n * Time in milliseconds to wait for GQL_CONNECTION_INIT message\n */\nvar CONNECTION_INIT_TIMEOUT = 15000;\n/**\n * Time in milliseconds to wait for GQL_START_ACK message\n */\nvar START_ACK_TIMEOUT = 15000;\n/**\n * Default Time in milliseconds to wait for GQL_CONNECTION_KEEP_ALIVE message\n */\nvar DEFAULT_KEEP_ALIVE_TIMEOUT = 5 * 60 * 1000;\nvar AppSyncRealTimeSubscriptionHandshakeLink = /** @class */ (function (_super) {\n    __extends(AppSyncRealTimeSubscriptionHandshakeLink, _super);\n    function AppSyncRealTimeSubscriptionHandshakeLink(_a) {\n        var theUrl = _a.url, theRegion = _a.region, theAuth = _a.auth;\n        var _this = _super.call(this) || this;\n        _this.socketStatus = types_1.SOCKET_STATUS.CLOSED;\n        _this.keepAliveTimeout = DEFAULT_KEEP_ALIVE_TIMEOUT;\n        _this.subscriptionObserverMap = new Map();\n        _this.promiseArray = [];\n        _this.url = theUrl;\n        _this.region = theRegion;\n        _this.auth = theAuth;\n        return _this;\n    }\n    AppSyncRealTimeSubscriptionHandshakeLink.prototype.request = function (operation) {\n        var _a;\n        var _this = this;\n        var query = operation.query, variables = operation.variables;\n        var _b = operation.getContext(), _c = _b.controlMessages, _d = exports.CONTROL_EVENTS_KEY, controlEvents = (_c === void 0 ? (_a = {},\n            _a[exports.CONTROL_EVENTS_KEY] = undefined,\n            _a) : _c)[_d], headers = _b.headers;\n        return new apollo_link_1.Observable(function (observer) {\n            if (!_this.url) {\n                observer.error({\n                    errors: [\n                        __assign({}, new graphql_1.GraphQLError(\"Subscribe only available for AWS AppSync endpoint\")),\n                    ],\n                });\n                observer.complete();\n            }\n            else {\n                var subscriptionId_1 = uuid_1.v4();\n                var token = _this.auth.type === aws_appsync_auth_link_1.AUTH_TYPE.AMAZON_COGNITO_USER_POOLS ||\n                    _this.auth.type === aws_appsync_auth_link_1.AUTH_TYPE.OPENID_CONNECT\n                    ? _this.auth.jwtToken\n                    : null;\n                token =\n                    _this.auth.type === aws_appsync_auth_link_1.AUTH_TYPE.AWS_LAMBDA ? _this.auth.token : token;\n                var options = {\n                    appSyncGraphqlEndpoint: _this.url,\n                    authenticationType: _this.auth.type,\n                    query: graphql_1.print(query),\n                    region: _this.region,\n                    graphql_headers: function () { return headers; },\n                    variables: variables,\n                    apiKey: _this.auth.type === aws_appsync_auth_link_1.AUTH_TYPE.API_KEY ? _this.auth.apiKey : \"\",\n                    credentials: _this.auth.type === aws_appsync_auth_link_1.AUTH_TYPE.AWS_IAM ? _this.auth.credentials : null,\n                    token: token,\n                };\n                _this._startSubscriptionWithAWSAppSyncRealTime({\n                    options: options,\n                    observer: observer,\n                    subscriptionId: subscriptionId_1,\n                });\n                return function () { return __awaiter(_this, void 0, void 0, function () {\n                    var subscriptionState;\n                    return __generator(this, function (_a) {\n                        // Cleanup after unsubscribing or observer.complete was called after _startSubscriptionWithAWSAppSyncRealTime\n                        try {\n                            this._verifySubscriptionAlreadyStarted(subscriptionId_1);\n                            subscriptionState = this.subscriptionObserverMap.get(subscriptionId_1).subscriptionState;\n                            if (subscriptionState === types_1.SUBSCRIPTION_STATUS.CONNECTED) {\n                                this._sendUnsubscriptionMessage(subscriptionId_1);\n                            }\n                            else {\n                                throw new Error(\"Subscription has failed, starting to remove subscription.\");\n                            }\n                        }\n                        catch (err) {\n                            this._removeSubscriptionObserver(subscriptionId_1);\n                            return [2 /*return*/];\n                        }\n                        return [2 /*return*/];\n                    });\n                }); };\n            }\n        }).filter(function (data) {\n            var _a = data.extensions, _b = (_a === void 0 ? {} : _a).controlMsgType, controlMsgType = _b === void 0 ? undefined : _b;\n            var isControlMsg = typeof controlMsgType !== \"undefined\";\n            return controlEvents === true || !isControlMsg;\n        });\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink.prototype._verifySubscriptionAlreadyStarted = function (subscriptionId) {\n        return __awaiter(this, void 0, void 0, function () {\n            var subscriptionState;\n            var _this = this;\n            return __generator(this, function (_a) {\n                subscriptionState = this.subscriptionObserverMap.get(subscriptionId).subscriptionState;\n                // This in case unsubscribe is invoked before sending start subscription message\n                if (subscriptionState === types_1.SUBSCRIPTION_STATUS.PENDING) {\n                    return [2 /*return*/, new Promise(function (res, rej) {\n                            var _a = _this.subscriptionObserverMap.get(subscriptionId), observer = _a.observer, subscriptionState = _a.subscriptionState, variables = _a.variables, query = _a.query;\n                            _this.subscriptionObserverMap.set(subscriptionId, {\n                                observer: observer,\n                                subscriptionState: subscriptionState,\n                                variables: variables,\n                                query: query,\n                                subscriptionReadyCallback: res,\n                                subscriptionFailedCallback: rej,\n                            });\n                        })];\n                }\n                return [2 /*return*/];\n            });\n        });\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink.prototype._sendUnsubscriptionMessage = function (subscriptionId) {\n        try {\n            if (this.awsRealTimeSocket &&\n                this.awsRealTimeSocket.readyState === WebSocket.OPEN &&\n                this.socketStatus === types_1.SOCKET_STATUS.READY) {\n                // Preparing unsubscribe message to stop receiving messages for that subscription\n                var unsubscribeMessage = {\n                    id: subscriptionId,\n                    type: types_1.MESSAGE_TYPES.GQL_STOP,\n                };\n                var stringToAWSRealTime = JSON.stringify(unsubscribeMessage);\n                this.awsRealTimeSocket.send(stringToAWSRealTime);\n                this._removeSubscriptionObserver(subscriptionId);\n            }\n        }\n        catch (err) {\n            // If GQL_STOP is not sent because of disconnection issue, then there is nothing the client can do\n            logger({ err: err });\n        }\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink.prototype._removeSubscriptionObserver = function (subscriptionId) {\n        this.subscriptionObserverMap.delete(subscriptionId);\n        // Verifying for 1000ms after removing subscription in case there are new subscriptions on mount / unmount\n        setTimeout(this._closeSocketIfRequired.bind(this), 1000);\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink.prototype._closeSocketIfRequired = function () {\n        if (this.subscriptionObserverMap.size > 0) {\n            // There are active subscriptions on the WebSocket\n            return;\n        }\n        if (!this.awsRealTimeSocket) {\n            this.socketStatus = types_1.SOCKET_STATUS.CLOSED;\n            return;\n        }\n        if (this.awsRealTimeSocket.bufferedAmount > 0) {\n            // There is still data on the WebSocket\n            setTimeout(this._closeSocketIfRequired.bind(this), 1000);\n        }\n        else {\n            logger(\"closing WebSocket...\");\n            clearTimeout(this.keepAliveTimeoutId);\n            var tempSocket = this.awsRealTimeSocket;\n            tempSocket.close(1000);\n            this.awsRealTimeSocket = null;\n            this.socketStatus = types_1.SOCKET_STATUS.CLOSED;\n        }\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink.prototype._startSubscriptionWithAWSAppSyncRealTime = function (_a) {\n        var options = _a.options, observer = _a.observer, subscriptionId = _a.subscriptionId;\n        return __awaiter(this, void 0, void 0, function () {\n            var appSyncGraphqlEndpoint, authenticationType, query, variables, apiKey, region, _b, graphql_headers, credentials, token, subscriptionState, data, dataString, headerObj, _c, subscriptionMessage, stringToAWSRealTime, err_1, _d, message, subscriptionFailedCallback_1, _e, subscriptionFailedCallback, subscriptionReadyCallback;\n            var _f;\n            var _this = this;\n            return __generator(this, function (_g) {\n                switch (_g.label) {\n                    case 0:\n                        appSyncGraphqlEndpoint = options.appSyncGraphqlEndpoint, authenticationType = options.authenticationType, query = options.query, variables = options.variables, apiKey = options.apiKey, region = options.region, _b = options.graphql_headers, graphql_headers = _b === void 0 ? function () { return ({}); } : _b, credentials = options.credentials, token = options.token;\n                        subscriptionState = types_1.SUBSCRIPTION_STATUS.PENDING;\n                        data = {\n                            query: query,\n                            variables: variables,\n                        };\n                        // Having a subscription id map will make it simple to forward messages received\n                        this.subscriptionObserverMap.set(subscriptionId, {\n                            observer: observer,\n                            query: query,\n                            variables: variables,\n                            subscriptionState: subscriptionState,\n                            startAckTimeoutId: null,\n                        });\n                        dataString = JSON.stringify(data);\n                        _c = [{}];\n                        return [4 /*yield*/, this._awsRealTimeHeaderBasedAuth({\n                                apiKey: apiKey,\n                                appSyncGraphqlEndpoint: appSyncGraphqlEndpoint,\n                                authenticationType: authenticationType,\n                                payload: dataString,\n                                canonicalUri: \"\",\n                                region: region,\n                                credentials: credentials,\n                                token: token,\n                                graphql_headers: graphql_headers,\n                            })];\n                    case 1:\n                        headerObj = __assign.apply(void 0, [__assign.apply(void 0, _c.concat([(_g.sent())])), (_f = {}, _f[aws_appsync_auth_link_1.USER_AGENT_HEADER] = aws_appsync_auth_link_1.USER_AGENT, _f)]);\n                        subscriptionMessage = {\n                            id: subscriptionId,\n                            payload: {\n                                data: dataString,\n                                extensions: {\n                                    authorization: __assign({}, headerObj),\n                                },\n                            },\n                            type: types_1.MESSAGE_TYPES.GQL_START,\n                        };\n                        stringToAWSRealTime = JSON.stringify(subscriptionMessage);\n                        _g.label = 2;\n                    case 2:\n                        _g.trys.push([2, 4, , 5]);\n                        return [4 /*yield*/, this._initializeWebSocketConnection({\n                                apiKey: apiKey,\n                                appSyncGraphqlEndpoint: appSyncGraphqlEndpoint,\n                                authenticationType: authenticationType,\n                                region: region,\n                                credentials: credentials,\n                                token: token,\n                            })];\n                    case 3:\n                        _g.sent();\n                        return [3 /*break*/, 5];\n                    case 4:\n                        err_1 = _g.sent();\n                        _d = err_1.message, message = _d === void 0 ? \"\" : _d;\n                        observer.error({\n                            errors: [\n                                __assign({}, new graphql_1.GraphQLError(\"Connection failed: \" + message)),\n                            ],\n                        });\n                        observer.complete();\n                        subscriptionFailedCallback_1 = (this.subscriptionObserverMap.get(subscriptionId) || {}).subscriptionFailedCallback;\n                        // Notify concurrent unsubscription\n                        if (typeof subscriptionFailedCallback_1 === \"function\") {\n                            subscriptionFailedCallback_1();\n                        }\n                        return [2 /*return*/];\n                    case 5:\n                        _e = this.subscriptionObserverMap.get(subscriptionId), subscriptionFailedCallback = _e.subscriptionFailedCallback, subscriptionReadyCallback = _e.subscriptionReadyCallback;\n                        // This must be done before sending the message in order to be listening immediately\n                        this.subscriptionObserverMap.set(subscriptionId, {\n                            observer: observer,\n                            subscriptionState: subscriptionState,\n                            variables: variables,\n                            query: query,\n                            subscriptionReadyCallback: subscriptionReadyCallback,\n                            subscriptionFailedCallback: subscriptionFailedCallback,\n                            startAckTimeoutId: setTimeout(function () {\n                                _this._timeoutStartSubscriptionAck.call(_this, subscriptionId);\n                            }, START_ACK_TIMEOUT),\n                        });\n                        if (this.awsRealTimeSocket) {\n                            this.awsRealTimeSocket.send(stringToAWSRealTime);\n                        }\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink.prototype._initializeWebSocketConnection = function (_a) {\n        var _this = this;\n        var appSyncGraphqlEndpoint = _a.appSyncGraphqlEndpoint, authenticationType = _a.authenticationType, apiKey = _a.apiKey, region = _a.region, credentials = _a.credentials, token = _a.token;\n        if (this.socketStatus === types_1.SOCKET_STATUS.READY) {\n            return;\n        }\n        return new Promise(function (res, rej) { return __awaiter(_this, void 0, void 0, function () {\n            var discoverableEndpoint, payloadString, headerString, _a, _b, headerQs, payloadQs, awsRealTimeUrl, err_2;\n            return __generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        this.promiseArray.push({ res: res, rej: rej });\n                        if (!(this.socketStatus === types_1.SOCKET_STATUS.CLOSED)) return [3 /*break*/, 5];\n                        _c.label = 1;\n                    case 1:\n                        _c.trys.push([1, 4, , 5]);\n                        this.socketStatus = types_1.SOCKET_STATUS.CONNECTING;\n                        discoverableEndpoint = AppSyncRealTimeSubscriptionHandshakeLink._discoverAppSyncRealTimeEndpoint(this.url);\n                        payloadString = \"{}\";\n                        _b = (_a = JSON).stringify;\n                        return [4 /*yield*/, this._awsRealTimeHeaderBasedAuth({\n                                authenticationType: authenticationType,\n                                payload: payloadString,\n                                canonicalUri: \"/connect\",\n                                apiKey: apiKey,\n                                appSyncGraphqlEndpoint: appSyncGraphqlEndpoint,\n                                region: region,\n                                credentials: credentials,\n                                token: token,\n                                graphql_headers: function () { },\n                            })];\n                    case 2:\n                        headerString = _b.apply(_a, [_c.sent()]);\n                        headerQs = Buffer.from(headerString).toString(\"base64\");\n                        payloadQs = Buffer.from(payloadString).toString(\"base64\");\n                        awsRealTimeUrl = discoverableEndpoint + \"?header=\" + headerQs + \"&payload=\" + payloadQs;\n                        return [4 /*yield*/, this._initializeRetryableHandshake({ awsRealTimeUrl: awsRealTimeUrl })];\n                    case 3:\n                        _c.sent();\n                        this.promiseArray.forEach(function (_a) {\n                            var res = _a.res;\n                            logger(\"Notifying connection successful\");\n                            res();\n                        });\n                        this.socketStatus = types_1.SOCKET_STATUS.READY;\n                        this.promiseArray = [];\n                        return [3 /*break*/, 5];\n                    case 4:\n                        err_2 = _c.sent();\n                        this.promiseArray.forEach(function (_a) {\n                            var rej = _a.rej;\n                            return rej(err_2);\n                        });\n                        this.promiseArray = [];\n                        if (this.awsRealTimeSocket &&\n                            this.awsRealTimeSocket.readyState === WebSocket.OPEN) {\n                            this.awsRealTimeSocket.close(3001);\n                        }\n                        this.awsRealTimeSocket = null;\n                        this.socketStatus = types_1.SOCKET_STATUS.CLOSED;\n                        return [3 /*break*/, 5];\n                    case 5: return [2 /*return*/];\n                }\n            });\n        }); });\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink.prototype._awsRealTimeHeaderBasedAuth = function (_a) {\n        var authenticationType = _a.authenticationType, payload = _a.payload, canonicalUri = _a.canonicalUri, appSyncGraphqlEndpoint = _a.appSyncGraphqlEndpoint, apiKey = _a.apiKey, region = _a.region, credentials = _a.credentials, token = _a.token, graphql_headers = _a.graphql_headers;\n        return __awaiter(this, void 0, void 0, function () {\n            var headerHandler, handler, host, result;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        headerHandler = {\n                            API_KEY: this._awsRealTimeApiKeyHeader.bind(this),\n                            AWS_IAM: this._awsRealTimeIAMHeader.bind(this),\n                            OPENID_CONNECT: this._awsRealTimeAuthorizationHeader.bind(this),\n                            AMAZON_COGNITO_USER_POOLS: this._awsRealTimeAuthorizationHeader.bind(this),\n                            AWS_LAMBDA: this._awsRealTimeAuthorizationHeader.bind(this),\n                        };\n                        handler = headerHandler[authenticationType];\n                        if (typeof handler !== \"function\") {\n                            logger(\"Authentication type \" + authenticationType + \" not supported\");\n                            return [2 /*return*/, {}];\n                        }\n                        host = url.parse(appSyncGraphqlEndpoint).host;\n                        return [4 /*yield*/, handler({\n                                payload: payload,\n                                canonicalUri: canonicalUri,\n                                appSyncGraphqlEndpoint: appSyncGraphqlEndpoint,\n                                apiKey: apiKey,\n                                region: region,\n                                host: host,\n                                credentials: credentials,\n                                token: token,\n                                graphql_headers: graphql_headers,\n                            })];\n                    case 1:\n                        result = _b.sent();\n                        return [2 /*return*/, result];\n                }\n            });\n        });\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink.prototype._awsRealTimeAuthorizationHeader = function (_a) {\n        var host = _a.host, token = _a.token, graphql_headers = _a.graphql_headers;\n        return __awaiter(this, void 0, void 0, function () {\n            var _b, _c, _d;\n            return __generator(this, function (_e) {\n                switch (_e.label) {\n                    case 0:\n                        _b = {};\n                        if (!(typeof token === \"function\")) return [3 /*break*/, 2];\n                        return [4 /*yield*/, token.call(undefined)];\n                    case 1:\n                        _c = _e.sent();\n                        return [3 /*break*/, 4];\n                    case 2: return [4 /*yield*/, token];\n                    case 3:\n                        _c = _e.sent();\n                        _e.label = 4;\n                    case 4:\n                        _d = [(_b.Authorization = _c, _b.host = host, _b)];\n                        return [4 /*yield*/, graphql_headers()];\n                    case 5: return [2 /*return*/, __assign.apply(void 0, _d.concat([(_e.sent())]))];\n                }\n            });\n        });\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink.prototype._awsRealTimeApiKeyHeader = function (_a) {\n        var apiKey = _a.apiKey, host = _a.host, graphql_headers = _a.graphql_headers;\n        return __awaiter(this, void 0, void 0, function () {\n            var dt, dtStr, _b;\n            return __generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        dt = new Date();\n                        dtStr = dt.toISOString().replace(/[:\\-]|\\.\\d{3}/g, \"\");\n                        _b = [{ host: host, \"x-amz-date\": dtStr, \"x-api-key\": apiKey }];\n                        return [4 /*yield*/, graphql_headers()];\n                    case 1: return [2 /*return*/, __assign.apply(void 0, _b.concat([(_c.sent())]))];\n                }\n            });\n        });\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink.prototype._awsRealTimeIAMHeader = function (_a) {\n        var payload = _a.payload, canonicalUri = _a.canonicalUri, appSyncGraphqlEndpoint = _a.appSyncGraphqlEndpoint, region = _a.region, credentials = _a.credentials;\n        return __awaiter(this, void 0, void 0, function () {\n            var endpointInfo, creds, _b, accessKeyId, secretAccessKey, sessionToken, formattedCredentials, request, signed_params;\n            return __generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        endpointInfo = {\n                            region: region,\n                            service: SERVICE,\n                        };\n                        creds = typeof credentials === \"function\"\n                            ? credentials.call()\n                            : credentials || {};\n                        if (!(creds && typeof creds.getPromise === \"function\")) return [3 /*break*/, 2];\n                        return [4 /*yield*/, creds.getPromise()];\n                    case 1:\n                        _c.sent();\n                        _c.label = 2;\n                    case 2:\n                        if (!creds) {\n                            throw new Error(\"No credentials\");\n                        }\n                        return [4 /*yield*/, creds];\n                    case 3:\n                        _b = _c.sent(), accessKeyId = _b.accessKeyId, secretAccessKey = _b.secretAccessKey, sessionToken = _b.sessionToken;\n                        formattedCredentials = {\n                            access_key: accessKeyId,\n                            secret_key: secretAccessKey,\n                            session_token: sessionToken,\n                        };\n                        request = {\n                            url: \"\" + appSyncGraphqlEndpoint + canonicalUri,\n                            body: payload,\n                            method: \"POST\",\n                            headers: __assign({}, APPSYNC_REALTIME_HEADERS),\n                        };\n                        signed_params = aws_appsync_auth_link_1.Signer.sign(request, formattedCredentials, endpointInfo);\n                        return [2 /*return*/, signed_params.headers];\n                }\n            });\n        });\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink.prototype._initializeRetryableHandshake = function (_a) {\n        var awsRealTimeUrl = _a.awsRealTimeUrl;\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        logger(\"Initializaling retryable Handshake\");\n                        return [4 /*yield*/, retry_1.jitteredExponentialRetry(this._initializeHandshake.bind(this), [\n                                { awsRealTimeUrl: awsRealTimeUrl },\n                            ])];\n                    case 1:\n                        _b.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink.prototype._initializeHandshake = function (_a) {\n        var awsRealTimeUrl = _a.awsRealTimeUrl;\n        return __awaiter(this, void 0, void 0, function () {\n            var err_3, errorType, errorCode;\n            var _this = this;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        logger(\"Initializing handshake \" + awsRealTimeUrl);\n                        _b.label = 1;\n                    case 1:\n                        _b.trys.push([1, 4, , 5]);\n                        return [4 /*yield*/, (function () {\n                                return new Promise(function (res, rej) {\n                                    var newSocket = AppSyncRealTimeSubscriptionHandshakeLink.createWebSocket(awsRealTimeUrl, \"graphql-ws\");\n                                    newSocket.onerror = function () {\n                                        logger(\"WebSocket connection error\");\n                                    };\n                                    newSocket.onclose = function () {\n                                        rej(new Error(\"Connection handshake error\"));\n                                    };\n                                    newSocket.onopen = function () {\n                                        _this.awsRealTimeSocket = newSocket;\n                                        return res();\n                                    };\n                                });\n                            })()];\n                    case 2:\n                        _b.sent();\n                        // Step 2: wait for ack from AWS AppSyncReaTime after sending init\n                        return [4 /*yield*/, (function () {\n                                return new Promise(function (res, rej) {\n                                    var ackOk = false;\n                                    _this.awsRealTimeSocket.onerror = function (error) {\n                                        logger(\"WebSocket closed \" + JSON.stringify(error));\n                                    };\n                                    _this.awsRealTimeSocket.onclose = function (event) {\n                                        logger(\"WebSocket closed \" + event.reason);\n                                        rej(new Error(JSON.stringify(event)));\n                                    };\n                                    _this.awsRealTimeSocket.onmessage = function (message) {\n                                        logger(\"subscription message from AWS AppSyncRealTime: \" + message.data + \" \");\n                                        var data = JSON.parse(message.data);\n                                        var type = data.type, _a = data.payload, _b = (_a === void 0 ? {} : _a).connectionTimeoutMs, connectionTimeoutMs = _b === void 0 ? DEFAULT_KEEP_ALIVE_TIMEOUT : _b;\n                                        if (type === types_1.MESSAGE_TYPES.GQL_CONNECTION_ACK) {\n                                            ackOk = true;\n                                            _this.keepAliveTimeout = connectionTimeoutMs;\n                                            _this.awsRealTimeSocket.onmessage =\n                                                _this._handleIncomingSubscriptionMessage.bind(_this);\n                                            _this.awsRealTimeSocket.onerror = function (err) {\n                                                logger(err);\n                                                _this._errorDisconnect(types_1.CONTROL_MSG.CONNECTION_CLOSED);\n                                            };\n                                            _this.awsRealTimeSocket.onclose = function (event) {\n                                                logger(\"WebSocket closed \" + event.reason);\n                                                _this._errorDisconnect(types_1.CONTROL_MSG.CONNECTION_CLOSED);\n                                            };\n                                            res(\"Cool, connected to AWS AppSyncRealTime\");\n                                            return;\n                                        }\n                                        if (type === types_1.MESSAGE_TYPES.GQL_CONNECTION_ERROR) {\n                                            var _c = data.payload, _d = (_c === void 0 ? {} : _c).errors, _e = (_d === void 0 ? [] : _d)[0], _f = _e === void 0 ? {} : _e, _g = _f.errorType, errorType = _g === void 0 ? \"\" : _g, _h = _f.errorCode, errorCode = _h === void 0 ? 0 : _h;\n                                            rej({ errorType: errorType, errorCode: errorCode });\n                                        }\n                                    };\n                                    var gqlInit = {\n                                        type: types_1.MESSAGE_TYPES.GQL_CONNECTION_INIT,\n                                    };\n                                    _this.awsRealTimeSocket.send(JSON.stringify(gqlInit));\n                                    function checkAckOk() {\n                                        if (!ackOk) {\n                                            rej(new Error(\"Connection timeout: ack from AWSRealTime was not received on \" + CONNECTION_INIT_TIMEOUT + \" ms\"));\n                                        }\n                                    }\n                                    setTimeout(checkAckOk.bind(_this), CONNECTION_INIT_TIMEOUT);\n                                });\n                            })()];\n                    case 3:\n                        // Step 2: wait for ack from AWS AppSyncReaTime after sending init\n                        _b.sent();\n                        return [3 /*break*/, 5];\n                    case 4:\n                        err_3 = _b.sent();\n                        errorType = err_3.errorType, errorCode = err_3.errorCode;\n                        if (NON_RETRYABLE_CODES.indexOf(errorCode) >= 0) {\n                            throw new retry_1.NonRetryableError(errorType);\n                        }\n                        else if (errorType) {\n                            throw new Error(errorType);\n                        }\n                        else {\n                            throw err_3;\n                        }\n                        return [3 /*break*/, 5];\n                    case 5: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink.prototype._handleIncomingSubscriptionMessage = function (message) {\n        logger(\"subscription message from AWS AppSync RealTime: \" + message.data);\n        var _a = JSON.parse(message.data), _b = _a.id, id = _b === void 0 ? \"\" : _b, payload = _a.payload, type = _a.type;\n        var _c = this.subscriptionObserverMap.get(id) || {}, _d = _c.observer, observer = _d === void 0 ? null : _d, _e = _c.query, query = _e === void 0 ? \"\" : _e, _f = _c.variables, variables = _f === void 0 ? {} : _f, _g = _c.startAckTimeoutId, startAckTimeoutId = _g === void 0 ? 0 : _g, _h = _c.subscriptionReadyCallback, subscriptionReadyCallback = _h === void 0 ? null : _h, _j = _c.subscriptionFailedCallback, subscriptionFailedCallback = _j === void 0 ? null : _j;\n        logger({ id: id, observer: observer, query: query, variables: variables });\n        if (type === types_1.MESSAGE_TYPES.GQL_DATA && payload && payload.data) {\n            if (observer) {\n                observer.next(payload);\n            }\n            else {\n                logger(\"observer not found for id: \" + id);\n            }\n            return;\n        }\n        if (type === types_1.MESSAGE_TYPES.GQL_START_ACK) {\n            logger(\"subscription ready for \" + JSON.stringify({ query: query, variables: variables }));\n            if (typeof subscriptionReadyCallback === \"function\") {\n                subscriptionReadyCallback();\n            }\n            clearTimeout(startAckTimeoutId);\n            if (observer) {\n                observer.next({\n                    data: payload,\n                    extensions: {\n                        controlMsgType: \"CONNECTED\",\n                    },\n                });\n            }\n            else {\n                logger(\"observer not found for id: \" + id);\n            }\n            var subscriptionState = types_1.SUBSCRIPTION_STATUS.CONNECTED;\n            this.subscriptionObserverMap.set(id, {\n                observer: observer,\n                query: query,\n                variables: variables,\n                startAckTimeoutId: null,\n                subscriptionState: subscriptionState,\n                subscriptionReadyCallback: subscriptionReadyCallback,\n                subscriptionFailedCallback: subscriptionFailedCallback,\n            });\n            return;\n        }\n        if (type === types_1.MESSAGE_TYPES.GQL_CONNECTION_KEEP_ALIVE) {\n            clearTimeout(this.keepAliveTimeoutId);\n            this.keepAliveTimeoutId = setTimeout(this._errorDisconnect.bind(this, types_1.CONTROL_MSG.TIMEOUT_DISCONNECT), this.keepAliveTimeout);\n            return;\n        }\n        if (type === types_1.MESSAGE_TYPES.GQL_ERROR) {\n            var subscriptionState = types_1.SUBSCRIPTION_STATUS.FAILED;\n            this.subscriptionObserverMap.set(id, {\n                observer: observer,\n                query: query,\n                variables: variables,\n                startAckTimeoutId: startAckTimeoutId,\n                subscriptionReadyCallback: subscriptionReadyCallback,\n                subscriptionFailedCallback: subscriptionFailedCallback,\n                subscriptionState: subscriptionState,\n            });\n            observer.error({\n                errors: [\n                    __assign({}, new graphql_1.GraphQLError(\"Connection failed: \" + JSON.stringify(payload))),\n                ],\n            });\n            clearTimeout(startAckTimeoutId);\n            observer.complete();\n            if (typeof subscriptionFailedCallback === \"function\") {\n                subscriptionFailedCallback();\n            }\n        }\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink.prototype._errorDisconnect = function (msg) {\n        logger(\"Disconnect error: \" + msg);\n        this.subscriptionObserverMap.forEach(function (_a) {\n            var observer = _a.observer;\n            if (observer && !observer.closed) {\n                observer.error({\n                    errors: [__assign({}, new graphql_1.GraphQLError(msg))],\n                });\n            }\n        });\n        this.subscriptionObserverMap.clear();\n        if (this.awsRealTimeSocket) {\n            this.awsRealTimeSocket.close();\n        }\n        this.socketStatus = types_1.SOCKET_STATUS.CLOSED;\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink.prototype._timeoutStartSubscriptionAck = function (subscriptionId) {\n        var _a = this.subscriptionObserverMap.get(subscriptionId) || {}, observer = _a.observer, query = _a.query, variables = _a.variables;\n        if (!observer) {\n            return;\n        }\n        this.subscriptionObserverMap.set(subscriptionId, {\n            observer: observer,\n            query: query,\n            variables: variables,\n            subscriptionState: types_1.SUBSCRIPTION_STATUS.FAILED,\n        });\n        if (observer && !observer.closed) {\n            observer.error({\n                errors: [\n                    __assign({}, new graphql_1.GraphQLError(\"Subscription timeout \" + JSON.stringify({ query: query, variables: variables }))),\n                ],\n            });\n            // Cleanup will be automatically executed\n            observer.complete();\n        }\n        logger(\"timeoutStartSubscription\", JSON.stringify({ query: query, variables: variables }));\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink.createWebSocket = function (awsRealTimeUrl, protocol) {\n        return new WebSocket(awsRealTimeUrl, protocol);\n    };\n    AppSyncRealTimeSubscriptionHandshakeLink._discoverAppSyncRealTimeEndpoint = function (url) {\n        return url\n            .replace(\"https://\", \"wss://\")\n            .replace(\"http://\", \"ws://\")\n            .replace(\"appsync-api\", \"appsync-realtime-api\")\n            .replace(\"gogi-beta\", \"grt-beta\");\n    };\n    return AppSyncRealTimeSubscriptionHandshakeLink;\n}(apollo_link_1.ApolloLink));\nexports.AppSyncRealTimeSubscriptionHandshakeLink = AppSyncRealTimeSubscriptionHandshakeLink;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}